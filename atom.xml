<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>57°极客闷骚</title>
  <icon>https://www.gravatar.com/avatar/2249723788cb270e215b1dd8fa06f947</icon>
  <subtitle>Yes, you can!</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mapele.coding.me/"/>
  <updated>2019-05-14T07:28:41.804Z</updated>
  <id>http://mapele.coding.me/</id>
  
  <author>
    <name>Mapele</name>
    <email>wuy.xiao@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从TO_NUMBER报ORA-01722  invalid number展开了去...</title>
    <link href="http://mapele.coding.me/posts/51019/"/>
    <id>http://mapele.coding.me/posts/51019/</id>
    <published>2019-05-13T07:55:22.000Z</published>
    <updated>2019-05-14T07:28:41.804Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p><strong>前不久一位开发同事突然问我：他写的一个简单的sql语句中的TO_NUMBER报ORA-01722  invalid number错误，要to_number的字段是varchar类型，其中只有一条数据的这个字段值不能转换为数字；他将这个值排除掉，然后转换为数字进行条件查询，但是一直报题目中的错误，即无效数字。sql如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SELECT COUNT(1)</div><div class="line">  FROM (SELECT USER_ID</div><div class="line">          FROM T_USER_INFO UI</div><div class="line">         WHERE UI.USER_ID &lt;&gt; &apos;SYS_000&apos;)</div><div class="line"> WHERE USER_ID &gt; 21361059;</div><div class="line">ERROR:</div><div class="line">ORA-01722: invalid number</div></pre></td></tr></table></figure><p><strong>该sql统计排除用户“SYS_000”后用户ID大于“21361059”的用户数量（用户ID自增长，只是个别用户可能来自于特殊生成方式）。sql很简单，简单从表面逻辑上理解，在排除特殊的用户后，语句不应该再报 ORA-01722  invalid number 错误。接下来我们看看这到底是怎么回事。</strong></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS 6.5 64位</td></tr><tr><td>数据库版本</td><td>11.2.0.1、11.2.0.4</td></tr><tr><td>RAC</td><td>否</td></tr></tbody></table><h3 id="模拟环境"><a href="#模拟环境" class="headerlink" title="模拟环境"></a>模拟环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SQL&gt; create table test(id int,user_id varchar2(30));</div><div class="line">SQL&gt; insert into test values(1,&apos;111&apos;);</div><div class="line">SQL&gt; insert into test values(2,&apos;222&apos;);</div><div class="line">SQL&gt; insert into test values(3,&apos;333&apos;);</div><div class="line">SQL&gt; insert into test values(4,&apos;444&apos;);</div><div class="line">SQL&gt; insert into test values(5,&apos;sys01&apos;);</div><div class="line">SQL&gt; insert into test values(6,&apos;666&apos;);</div><div class="line">SQL&gt; insert into test values(7,&apos;777&apos;);</div><div class="line">SQL&gt; commit;</div><div class="line">Commit complete.</div></pre></td></tr></table></figure><h3 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select * </div><div class="line">       from (select * </div><div class="line">               from test t </div><div class="line">              where t.user_id&lt;&gt;&apos;sys01&apos;) </div><div class="line">      where to_number(user_id)&gt;1;</div><div class="line"></div><div class="line">        ID USER_ID</div><div class="line">---------- ------------------------------</div><div class="line">         1 111</div><div class="line">         2 222</div><div class="line">         3 333</div><div class="line">         4 444</div><div class="line">         6 666</div><div class="line">         7 777</div><div class="line">6 rows selected.</div><div class="line"></div><div class="line">SQL&gt; exec dbms_stats.gather_table_stats(&apos;XWY&apos;,&apos;TEST&apos;);</div><div class="line">PL/SQL procedure successfully completed.</div><div class="line">SQL&gt; select * </div><div class="line">       from (select * </div><div class="line">               from test t </div><div class="line">              where t.user_id&lt;&gt;&apos;sys01&apos;) </div><div class="line">      where to_number(user_id)&gt;1;</div><div class="line">ERROR:</div><div class="line">ORA-01722: invalid number</div></pre></td></tr></table></figure><p><em>可以看出，在表未做统计分析情况下，可以查出数据，没有报ORA-01722  invalid number错误，但是有统计情况下确报错。这是为什么呢，其实看看他们的执行计划就明白了：</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">--没有统计表情况下的执行计划</div><div class="line">Execution Plan</div><div class="line">----------------------------------------------------------</div><div class="line">Plan hash value: 1357081020</div><div class="line">---------------------------------------------------------------------------</div><div class="line">| Id  | Operation         | Name  | Rows  | Bytes | Cost (%CPU)| Time     |</div><div class="line">---------------------------------------------------------------------------</div><div class="line">|   0 | SELECT STATEMENT  |       |     1 |    30 |     3   (0)| 00:00:01 |</div><div class="line">|*  1 |  TABLE ACCESS FULL| TEST  |     1 |    30 |     3   (0)| 00:00:01 |</div><div class="line">---------------------------------------------------------------------------</div><div class="line">Predicate Information (identified by operation id):</div><div class="line">---------------------------------------------------</div><div class="line">   1 - filter(&quot;T&quot;.&quot;USER_ID&quot;&lt;&gt;&apos;sys01&apos; AND TO_NUMBER(&quot;T&quot;.&quot;USER_ID&quot;)&gt;1)</div><div class="line"></div><div class="line">--有统计表情况下的执行计划</div><div class="line">Execution Plan</div><div class="line">----------------------------------------------------------</div><div class="line">Plan hash value: 1357081020</div><div class="line">--------------------------------------------------------------------------</div><div class="line">| Id  | Operation         | Name | Rows  | Bytes | Cost (%CPU)| Time     |</div><div class="line">--------------------------------------------------------------------------</div><div class="line">|   0 | SELECT STATEMENT  |      |     1 |     7 |     3   (0)| 00:00:01 |</div><div class="line">|*  1 |  TABLE ACCESS FULL| TEST |     1 |     7 |     3   (0)| 00:00:01 |</div><div class="line">--------------------------------------------------------------------------</div><div class="line">Predicate Information (identified by operation id):</div><div class="line">---------------------------------------------------</div><div class="line">   1 - filter(TO_NUMBER(&quot;T&quot;.&quot;USER_ID&quot;)&gt;1 AND &quot;T&quot;.&quot;USER_ID&quot;&lt;&gt;&apos;sys01&apos;)</div></pre></td></tr></table></figure><p><em>可以看到唯一的区别就是在filter的时候顺序，没有统计表情况下，”先执行T”.”USER_ID”&lt;&gt;’sys01’ 然后TO_NUMBER(“T”.”USER_ID”)&gt;1，这种情况无效数字已经排除，当然不会报错；有统计表情况下，先进行全表数据扫描，看是否满足过滤条件：TO_NUMBER(“T”.”USER_ID”)&gt;1，因为存在无法转换为数字的字符，当然报错。</em></p><h3 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h3><p><strong>很明显同事只是简单的从sql的写法上去表的了业务逻辑，他想让sql按照所写逻辑伪代码去执行。从sql上来说我们先放下去考虑这个语句写法是否合理，从上面的测试当中可以看出，我们只要能让sql的执行计划执行的时候能先排除无法转为数字的记录在执行后面的条件就可以了。</strong></p><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p><strong>其实就是还原测试当中，我们在没有表统计情况下的能正常执行的情况。但是Oracle会自动执行表的统计分析（可以让数据库根据统计信息指定合理执行计划）。但是我们总不能因为这个sql而改变整个系统吧。所以此时我们可以暂时使用Hint提示Oracle按照基于Rule生成计划执行。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT /*+ rule*/ *</div><div class="line">       FROM (SELECT A.* FROM TEST A WHERE A.USER_ID &lt;&gt; &apos;sys01&apos;)</div><div class="line">      WHERE USER_ID &gt; 1;</div><div class="line"></div><div class="line">        ID USER_ID</div><div class="line">---------- ------------------------------</div><div class="line">         1 111</div><div class="line">         2 222</div><div class="line">         3 333</div><div class="line">         4 444</div><div class="line">         6 666</div><div class="line">         7 777</div><div class="line">6 rows selected.</div><div class="line">Execution Plan</div><div class="line">----------------------------------------------------------</div><div class="line">Plan hash value: 1357081020</div><div class="line">----------------------------------</div><div class="line">| Id  | Operation         | Name |</div><div class="line">----------------------------------</div><div class="line">|   0 | SELECT STATEMENT  |      |</div><div class="line">|*  1 |  TABLE ACCESS FULL| TEST |</div><div class="line">----------------------------------</div><div class="line">Predicate Information (identified by operation id):</div><div class="line">---------------------------------------------------</div><div class="line">   1 - filter(&quot;A&quot;.&quot;USER_ID&quot;&lt;&gt;&apos;sys01&apos; AND TO_NUMBER(&quot;A&quot;.&quot;USER_ID&quot;)&gt;1)</div></pre></td></tr></table></figure><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p><strong>我们可以利用 with as 结合 materialize hint,这样在执行的时候能先使子查询的结果生成一个临时表固化下来，然后在这个结果集上面执行转换函数，当然就不会报错啦</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">WITH T AS</div><div class="line">     (SELECT /*+ materialize */ A.*</div><div class="line">        FROM TEST A</div><div class="line">       WHERE A.USER_ID &lt;&gt; &apos;sys01&apos;)</div><div class="line">SELECT * FROM T WHERE TO_NUMBER(T.USER_ID) &gt; 1;</div><div class="line"></div><div class="line">        ID USER_ID</div><div class="line">---------- ------------------------------</div><div class="line">         1 111</div><div class="line">         2 222</div><div class="line">         3 333</div><div class="line">         4 444</div><div class="line">         6 666</div><div class="line">         7 777</div><div class="line">6 rows selected.</div><div class="line">Execution Plan</div><div class="line">----------------------------------------------------------</div><div class="line">Plan hash value: 2049816044</div><div class="line">--------------------------------------------------------------------------------------------------------</div><div class="line">| Id  | Operation                  | Name                      | Rows  | Bytes | Cost (%CPU)| Time     |</div><div class="line">--------------------------------------------------------------------------------------------------------</div><div class="line">|   0 | SELECT STATEMENT           |                           |     6 |   180 |     5   (0)| 00:00:01 |</div><div class="line">|   1 |  TEMP TABLE TRANSFORMATION |                           |       |       |            |          |</div><div class="line">|   2 |   LOAD AS SELECT           | SYS_TEMP_0FD9D660E_101A7F |       |       |            |          |</div><div class="line">|*  3 |    TABLE ACCESS FULL       | TEST                      |     6 |    42 |     3   (0)| 00:00:01 |</div><div class="line">|*  4 |   VIEW                     |                           |     6 |   180 |     2   (0)| 00:00:01 |</div><div class="line">|   5 |    TABLE ACCESS FULL       | SYS_TEMP_0FD9D660E_101A7F |     6 |    42 |     2   (0)| 00:00:01 |</div><div class="line">--------------------------------------------------------------------------------------------------------</div><div class="line">Predicate Information (identified by operation id):</div><div class="line">---------------------------------------------------</div><div class="line">   3 - filter(&quot;A&quot;.&quot;USER_ID&quot;&lt;&gt;&apos;sys01&apos;)</div><div class="line">   4 - filter(TO_NUMBER(&quot;T&quot;.&quot;USER_ID&quot;)&gt;1)</div></pre></td></tr></table></figure><h4 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h4><p><strong>还可以利用子查询不展开 NO_UNNEST hint特性。这样子查询只能走filter进行过滤。这样做的唯一缺点就是，本来是一个表的很简单的查询，但是却扫描了两次。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">SELECT /*+ NO_UNNEST(@AA)*/ *</div><div class="line">  FROM TEST A</div><div class="line"> WHERE A.USER_ID &lt;&gt; &apos;sys01&apos;</div><div class="line">   AND EXISTS (SELECT /*+ QB_NAME(AA)*/ *</div><div class="line">                 FROM TEST T</div><div class="line">                 WHERE A.USER_ID = T.USER_ID</div><div class="line">                   AND T.USER_ID &gt; 1);</div><div class="line"></div><div class="line">        ID USER_ID</div><div class="line">---------- ------------------------------</div><div class="line">         1 111</div><div class="line">         2 222</div><div class="line">         3 333</div><div class="line">         4 444</div><div class="line">         6 666</div><div class="line">         7 777</div><div class="line">6 rows selected.</div><div class="line">Execution Plan</div><div class="line">----------------------------------------------------------</div><div class="line">Plan hash value: 1194824156</div><div class="line">---------------------------------------------------------------------------</div><div class="line">| Id  | Operation          | Name | Rows  | Bytes | Cost (%CPU)| Time     |</div><div class="line">---------------------------------------------------------------------------</div><div class="line">|   0 | SELECT STATEMENT   |      |     1 |     7 |    12   (0)| 00:00:01 |</div><div class="line">|*  1 |  FILTER            |      |       |       |            |          |</div><div class="line">|*  2 |   TABLE ACCESS FULL| TEST |     6 |    42 |     3   (0)| 00:00:01 |</div><div class="line">|*  3 |   TABLE ACCESS FULL| TEST |     1 |     5 |     3   (0)| 00:00:01 |</div><div class="line">---------------------------------------------------------------------------</div><div class="line">Predicate Information (identified by operation id):</div><div class="line">---------------------------------------------------</div><div class="line">   1 - filter( EXISTS (SELECT /*+ NO_UNNEST QB_NAME (&quot;AA&quot;) */ 0 FROM</div><div class="line">              &quot;TEST&quot; &quot;T&quot; WHERE &quot;T&quot;.&quot;USER_ID&quot;=:B1 AND TO_NUMBER(&quot;T&quot;.&quot;USER_ID&quot;)&gt;1))</div><div class="line">   2 - filter(&quot;A&quot;.&quot;USER_ID&quot;&lt;&gt;&apos;sys01&apos;)</div><div class="line">   3 - filter(&quot;T&quot;.&quot;USER_ID&quot;=:B1 AND TO_NUMBER(&quot;T&quot;.&quot;USER_ID&quot;)&gt;1)</div></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li><strong>数据库选择实际的执行计划是一个复杂的过程，不是简单的sql逻辑，所以我们写sql的时候千万不能想当然。</strong></li><li><strong>当sql执行结果与我们预想的不一致（发生错误、效率不高等等）我们可以从其实际的执行计划着手，找到真正原因。</strong></li><li><strong>就像Oracle对同一个sql可以生成不同的解决方案(执行计划)，我们解决问题的时候也要尽可能找到多种解决方案，这样才能比较，才能提高。</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;前不久一位开发同事突然问我：他写的一个简单的sql语句中的TO_NUMBER报ORA-01722  invalid numb
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="Ora-" scheme="http://mapele.coding.me/categories/Database/Oracle/Ora/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="ORA" scheme="http://mapele.coding.me/tags/ORA/"/>
    
  </entry>
  
  <entry>
    <title>Script—元数据获取AWR top timed events报告</title>
    <link href="http://mapele.coding.me/posts/51018/"/>
    <id>http://mapele.coding.me/posts/51018/</id>
    <published>2018-06-23T06:12:15.000Z</published>
    <updated>2019-05-14T08:13:32.446Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><strong>DBA往往需要在数据库性能问题的时候快速获取数据库负载信息，而AWR此时通常作为最有效的工具之一，虽然AWR很优秀，但是众所周知也存在一些缺陷，主要体现在如下两方面：</strong></p><ul><li><strong>内容繁多，用时较长</strong></li><li><strong>AWR统计的是begin_snap、end_snap两个快照间间累积差异，在这之间每个快照间的变化无法体现</strong></li></ul><p><strong>大家都知道AWR报告也都来源于数据库相关视图，因此只要我们弄清楚这些元数据的关系，就能按照我们自己的意愿组织我们自己所最关心的报告数据。</strong></p><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p><em>如下，这是自己参考相关资料总结的top timed events报告脚本，如果有需要可以通过下文的链接下载</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line">-- |                            runanyun Mapele                               |</div><div class="line">-- |                            wuyu.xiao@gmail.com                             |</div><div class="line">-- |             http://mapele.coding.me/ &amp;&amp; http://mapele.github.io/           |</div><div class="line">-- |----------------------------------------------------------------------------|</div><div class="line">-- | DATABASE : Oracle 11g(RAC)                                                 |</div><div class="line">-- | FILE     : awr_top_timed_events.sql                                        |</div><div class="line">-- | PURPOSE  : 通过裸数据获取AWR中连续快照间的Top Timed Events报告.               |</div><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line"></div><div class="line">WHENEVER SQLERROR EXIT SQL.SQLCODE</div><div class="line"></div><div class="line">SET VER OFF</div><div class="line">SET FEEDBACK OFF</div><div class="line"></div><div class="line">COLUMN PCT           FORMAT a15              HEADING &apos;PCT of DB TIMES&apos;</div><div class="line">COLUMN EVENT         FORMAT a40              HEADING &apos;EVENT&apos;</div><div class="line">COLUMN TIMES         FORMAT 999,999,990.99   HEADING &apos;TIMES(S)&apos;</div><div class="line">COLUMN INST_NO       FORMAT 99           HEADING &apos;INSNO&apos;</div><div class="line">COLUMN SNAP_ID       FORMAT 9999999       HEADING &apos;SNAP_ID&apos;</div><div class="line"></div><div class="line">PROMPT</div><div class="line">BREAK ON INST_NO skip page</div><div class="line"></div><div class="line">ACCEPT DAYS  number PROMPT &quot;ENTER latest snap days: &quot; default 7</div><div class="line"></div><div class="line">SELECT INSTANCE_NUMBER INST_NO,</div><div class="line">       SNAP_ID, </div><div class="line">   TO_CHAR(BEGIN_INTERVAL_TIME,&apos;YYYY-MM-DD HH24:MI:SS&apos;) BEGIN_INTERVAL_TIME</div><div class="line">  FROM DBA_HIST_SNAPSHOT</div><div class="line"> WHERE BEGIN_INTERVAL_TIME &gt; TRUNC(SYSDATE) - &amp;DAYS</div><div class="line"> ORDER BY INSTANCE_NUMBER,BEGIN_INTERVAL_TIME;</div><div class="line"></div><div class="line">PROMPT </div><div class="line"></div><div class="line">ACCEPT INST_NO    number PROMPT &quot;ENTER INSTANCE_NUMBER: &quot; default 0</div><div class="line">ACCEPT BEGIN_SNAP    number PROMPT &quot;ENTER BEGIN_SNAP: &quot;</div><div class="line">ACCEPT END_SNAP      number PROMPT &quot;ENTER END_SNAP: &quot;</div><div class="line">COMPUTE sum of TIMES on SNAP_ID</div><div class="line"></div><div class="line">PROMPT</div><div class="line">PROMPT Listing top timed events by instance no and snap id ...</div><div class="line">BREAK ON INST_NO ON SNAP_ID skip page</div><div class="line"></div><div class="line">SELECT A.INST_NO</div><div class="line">      ,TO_CHAR(B.BEGIN_INTERVAL_TIME, &apos;mmdd hh24mi&apos;) SNAP_TIME</div><div class="line">      ,A.SNAP_ID</div><div class="line">      ,A.EVENT</div><div class="line">      ,A.PCT || &apos;%&apos; PCT</div><div class="line">      ,A.TIMES</div><div class="line">  FROM (SELECT INSTANCE_NUMBER INST_NO</div><div class="line">              ,SNAP_ID-1 SNAP_ID</div><div class="line">              ,EVENT</div><div class="line">              ,ROUND(TIMES,2) TIMES</div><div class="line">              ,ROUND(RATIO_TO_REPORT(TIMES) OVER(PARTITION BY SNAP_ID) * 100,2) PCT</div><div class="line">          FROM (SELECT INSTANCE_NUMBER</div><div class="line">                      ,&apos;DB CPU&apos; EVENT</div><div class="line">                      ,SNAP_ID</div><div class="line">                      ,VALUE / 1E6 - LAG(VALUE) OVER(PARTITION BY INSTANCE_NUMBER, STAT_NAME ORDER BY SNAP_ID) / 1E6 TIMES</div><div class="line">                  FROM DBA_HIST_SYS_TIME_MODEL</div><div class="line">                 WHERE STAT_NAME = &apos;DB CPU&apos;</div><div class="line">   AND INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">                   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                UNION ALL</div><div class="line">                SELECT INSTANCE_NUMBER</div><div class="line">                      ,&apos;cpu on queue time&apos; EVENT</div><div class="line">                      ,SNAP_ID</div><div class="line">                      ,NVL(VALUE, 0) / 100 VALUE</div><div class="line">                  FROM DBA_HIST_OSSTAT T</div><div class="line">                 WHERE STAT_NAME = &apos;RSRC_MGR_CPU_WAIT_TIME&apos;</div><div class="line">                   AND INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">                   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                UNION ALL</div><div class="line">                SELECT INSTANCE_NUMBER</div><div class="line">                      ,EVENT_NAME</div><div class="line">                      ,SNAP_ID</div><div class="line">                      ,TIME_WAITED_MICRO_FG / 1E6 -</div><div class="line">                       LAG(TIME_WAITED_MICRO_FG) OVER(PARTITION BY INSTANCE_NUMBER, EVENT_NAME ORDER BY SNAP_ID) / 1E6</div><div class="line">                  FROM DBA_HIST_SYSTEM_EVENT</div><div class="line">                 WHERE WAIT_CLASS != &apos;Idle&apos;</div><div class="line">                   AND INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">                   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP)</div><div class="line">         WHERE TIMES &gt; 0) A</div><div class="line">      ,DBA_HIST_SNAPSHOT B</div><div class="line"> WHERE PCT &gt; 1</div><div class="line">   AND A.SNAP_ID = B.SNAP_ID</div><div class="line">   AND A.INST_NO = B.INSTANCE_NUMBER</div><div class="line">   AND A.SNAP_ID != &amp;BEGIN_SNAP-1</div><div class="line">   AND event != &apos;cpu on queue time&apos;</div><div class="line"> ORDER BY A.INST_NO</div><div class="line">         ,SNAP_ID</div><div class="line">         ,TIMES DESC;</div></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/05/14/5cda76fd050da63922.png" alt="AWR top timed events报告"></p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul><li><strong>大家都知道：DB time = DB CPU +non idle wait time+ os cpu run queue time + truer gap time，os cpu run queue time 在os层是一个较难准确把握的指标，有兴趣的同学可以参考这篇博文对它的研究：<a href="http://blog.orapub.com/20150304/how-os-cpu-run-queue-time-relates-to-oracle-database-db-time.html" rel="external nofollow noopener noreferrer" target="_blank">How OS CPU Run Queue Time Relates To Oracle Database Time</a>这里我直接使用DBA_HIST_OSSTAT中的RSRC_MGR_CPU_WAIT_TIME统计值。关于该值的说明可以参考<a href="https://docs.oracle.com/cd/B19306_01/server.102/b14237/dynviews_2010.htm#REFRN30321" rel="external nofollow noopener noreferrer" target="_blank">V$OSSTAT</a>。</strong></li><li><strong>为了保持与AWR报告中展示一致性，已在最终结果中过滤掉“cpu on queue time”，如果有需要请注释掉“AND event != ‘cpu on queue time’”</strong></li><li><strong>脚本已经在oracle 11.2.0.1、11.2.0.4单实例和RAC环境下通过测试</strong></li></ul><h3 id="脚本文件"><a href="#脚本文件" class="headerlink" title="脚本文件"></a>脚本文件</h3><p><a href="/files/awr_top_timed_events.sql">点击下载</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.enmotech.com/web/detail/1/330/2.html" rel="external nofollow noopener noreferrer" target="_blank">SQL玩转AWR裸数据-云和恩墨</a><br><a href="http://qkxue.net/info/181928/Oracle-AWR" rel="external nofollow noopener noreferrer" target="_blank">循序渐进解读Oracle AWR性能分析报告</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;DBA往往需要在数据库性能问题的时候快速获取数据库负载信息，而AWR此时通常作为最有效的工具之一，虽然AWR很优秀，但是众所
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/categories/Database/Oracle/Script/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/tags/Script/"/>
    
      <category term="AWR" scheme="http://mapele.coding.me/tags/AWR/"/>
    
  </entry>
  
  <entry>
    <title>Script—元数据获取load profile PCT报告</title>
    <link href="http://mapele.coding.me/posts/51017/"/>
    <id>http://mapele.coding.me/posts/51017/</id>
    <published>2018-06-22T03:32:03.000Z</published>
    <updated>2019-05-14T08:13:32.012Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><strong>当我们使用前面介绍的<a href="/posts/51016/">Script—元数据获取load profile报告</a>获得load profile各指标变化数据后，想简单的从数据集直接一眼看出指标的变化趋势还是相当不容易，此时我们会立马想到把数据集导入到excel中利用数据透视图展示数据，如下：</strong></p><ul><li><strong>原始load profile 数据集</strong></li></ul><p><img src="https://i.loli.net/2019/05/14/5cda750fa3e1040131.png" alt="原始load profile 数据集"></p><ul><li><strong>原始load profile 数据集产生的透视图</strong></li></ul><p><img src="https://i.loli.net/2019/05/14/5cda73ac3e7bd31076.png" alt="原始load profile 数据集产生的透视图"></p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p><em>如上图看到，因为不同指标数量值范围落差很大，导致部分指标值被挤压无法在透视图中提现变化趋势。</em></p><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p><em>我们可以在前面介绍的<a href="/posts/51016/">Script—元数据获取load profile报告</a>上，通过RATIO_TO_REPORT分析函数，计算结果集中每个值在同一指标种占比，这样就可以将数据统一起来，从而能很简单的从数据中判断出数据的变化趋势，也更方便在同一图上展示；脚本如下</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line">-- |                            runanyun Mapele                               |</div><div class="line">-- |                            wuyu.xiao@gmail.com                             |</div><div class="line">-- |             http://mapele.coding.me/ &amp;&amp; http://mapele.github.io/           |</div><div class="line">-- |----------------------------------------------------------------------------|</div><div class="line">-- | DATABASE : Oracle 11g(RAC)                                                 |</div><div class="line">-- | FILE     : awr_load_profile_pct.sql                                        |</div><div class="line">-- | PURPOSE  : 通过裸数据获取AWR中连续快照间的load profile pct报告.               |</div><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line"></div><div class="line">WHENEVER SQLERROR EXIT SQL.SQLCODE</div><div class="line"></div><div class="line">SET VER OFF</div><div class="line">set LINESIZE 200</div><div class="line">SET FEEDBACK OFF</div><div class="line"></div><div class="line">COLUMN INST_NO       FORMAT 99              HEADING &apos;INSNO&apos;</div><div class="line">COLUMN SNAP_ID       FORMAT 99999</div><div class="line">COLUMN &quot;DB time&quot;     FORMAT 9999</div><div class="line">COLUMN &quot;DB CPU&quot;      FORMAT 9999</div><div class="line">COLUMN Redo          FORMAT 9999</div><div class="line">COLUMN LogicalR      FORMAT 9999</div><div class="line">COLUMN BlockChs      FORMAT 9999</div><div class="line">COLUMN Phyr          FORMAT 9999</div><div class="line">COLUMN Phyw          FORMAT 9999</div><div class="line">COLUMN Calls         FORMAT 9999</div><div class="line">COLUMN Parses        FORMAT 9999</div><div class="line">COLUMN HParses       FORMAT 9999</div><div class="line">COLUMN Logons        FORMAT 9999</div><div class="line">COLUMN Execs         FORMAT 9999</div><div class="line">COLUMN Rbacks        FORMAT 9999</div><div class="line">COLUMN Trans         FORMAT 9999</div><div class="line"></div><div class="line">PROMPT</div><div class="line">BREAK ON INST_NO skip page</div><div class="line"></div><div class="line">ACCEPT DAYS  NUMBER PROMPT &quot;ENTER latest snap days: &quot; default 7</div><div class="line"></div><div class="line">SELECT INSTANCE_NUMBER INST_NO,</div><div class="line">       SNAP_ID, </div><div class="line">   TO_CHAR(BEGIN_INTERVAL_TIME,&apos;YYYY-MM-DD HH24:MI:SS&apos;) BEGIN_INTERVAL_TIME</div><div class="line">  FROM DBA_HIST_SNAPSHOT</div><div class="line"> WHERE BEGIN_INTERVAL_TIME &gt; TRUNC(SYSDATE) - &amp;DAYS</div><div class="line"> ORDER BY INSTANCE_NUMBER,BEGIN_INTERVAL_TIME;</div><div class="line"></div><div class="line">PROMPT </div><div class="line"></div><div class="line">ACCEPT INST_NO    NUMBER PROMPT &quot;ENTER INSTANCE_NUMBER: &quot; default 0</div><div class="line">ACCEPT BEGIN_SNAP    NUMBER PROMPT &quot;ENTER BEGIN_SNAP: &quot;</div><div class="line">ACCEPT END_SNAP      NUMBER PROMPT &quot;ENTER END_SNAP: &quot;</div><div class="line"></div><div class="line">PROMPT</div><div class="line">PROMPT Listing load profile pct by instance no and snap id ...</div><div class="line"></div><div class="line">SELECT *</div><div class="line">  FROM (SELECT INST_NO</div><div class="line">              ,SNAP_ID</div><div class="line">              ,SNAP_TIME</div><div class="line">              ,STAT_NAME</div><div class="line">              ,ROUND(RATIO_TO_REPORT(VALUE) OVER(PARTITION BY STAT_NAME) * 100,2) VALUE</div><div class="line">          FROM (SELECT TO_CHAR(HS.BEGIN_INTERVAL_TIME, &apos;mmdd hh24mi&apos;) SNAP_TIME,S.*</div><div class="line">                  FROM (SELECT T.INSTANCE_NUMBER INST_NO</div><div class="line">                              ,T.SNAP_ID - 1 SNAP_ID</div><div class="line">                              ,STAT_NAME</div><div class="line">                              ,NVL(VALUE - LAG(VALUE)</div><div class="line">                                   OVER(PARTITION BY T.INSTANCE_NUMBER,STAT_NAME ORDER BY T.INSTANCE_NUMBER,T.SNAP_ID),0) VALUE</div><div class="line">                          FROM DBA_HIST_SYS_TIME_MODEL T</div><div class="line">                         WHERE INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                           AND STAT_NAME IN (&apos;DB time&apos;, &apos;DB CPU&apos;)</div><div class="line">                        UNION ALL</div><div class="line">                        SELECT T.INSTANCE_NUMBER INST_NO</div><div class="line">                              ,T.SNAP_ID - 1 SNAP_ID</div><div class="line">                              ,STAT_NAME</div><div class="line">                              ,NVL(VALUE - LAG(VALUE)</div><div class="line">                                   OVER(PARTITION BY T.INSTANCE_NUMBER</div><div class="line">                                       ,STAT_NAME ORDER BY T.INSTANCE_NUMBER</div><div class="line">                                       ,T.SNAP_ID)</div><div class="line">                                  ,0) VALUE</div><div class="line">                          FROM DBA_HIST_SYSSTAT T</div><div class="line">                         WHERE INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                           AND STAT_NAME IN (&apos;redo size&apos;</div><div class="line">                                            ,&apos;session logical reads&apos;</div><div class="line">                                            ,&apos;db block changes&apos;</div><div class="line">                                            ,&apos;physical reads&apos;</div><div class="line">                                            ,&apos;physical writes&apos;</div><div class="line">                                            ,&apos;user calls&apos;</div><div class="line">                                            ,&apos;parse count (total)&apos;</div><div class="line">                                            ,&apos;parse count (hard)&apos;</div><div class="line">                                            ,&apos;logons cumulative&apos;</div><div class="line">                                            ,&apos;execute count&apos;</div><div class="line">                                            ,&apos;user rollbacks&apos;</div><div class="line">                                            ,&apos;user commits&apos;)) S</div><div class="line">                      ,DBA_HIST_SNAPSHOT HS</div><div class="line">                 WHERE S.SNAP_ID = HS.SNAP_ID</div><div class="line">   AND S.SNAP_ID != &amp;BEGIN_SNAP-1))</div><div class="line">PIVOT(SUM(VALUE)</div><div class="line">   FOR STAT_NAME IN(&apos;DB time&apos; AS &quot;DB time&quot;</div><div class="line">                    ,&apos;DB CPU&apos; AS &quot;DB CPU&quot;</div><div class="line">                    ,&apos;redo size&apos; AS &quot;Redo&quot;</div><div class="line">                    ,&apos;session logical reads&apos; AS &quot;LogicalR&quot;</div><div class="line">                    ,&apos;db block changes&apos; AS &quot;BlockChs&quot;</div><div class="line">                    ,&apos;physical reads&apos; AS &quot;Phyr&quot;</div><div class="line">                    ,&apos;physical writes&apos; AS &quot;Phyw&quot;</div><div class="line">                    ,&apos;user calls&apos; AS &quot;Calls&quot;</div><div class="line">                    ,&apos;parse count (total)&apos; AS &quot;Parses&quot;</div><div class="line">                    ,&apos;parse count (hard)&apos; AS &quot;HParses&quot;</div><div class="line">                    ,&apos;logons cumulative&apos; AS &quot;Logons&quot;</div><div class="line">                    ,&apos;execute count&apos; AS &quot;Execs&quot;</div><div class="line">                    ,&apos;user rollbacks&apos; AS &quot;Rbacks&quot;</div><div class="line">                    ,&apos;user commits&apos; AS &quot;Trans&quot;))</div><div class="line"> ORDER BY INST_NO</div><div class="line">         ,SNAP_TIME;</div></pre></td></tr></table></figure></p><ul><li><strong>load profile pct 数据集</strong></li></ul><p><img src="https://i.loli.net/2019/05/14/5cda752ec2ff992930.png" alt="load profile pct 数据集"></p><ul><li><strong>load profile pct 数据集产生的透视图</strong></li></ul><p><img src="https://i.loli.net/2019/05/14/5cda752f00e9911434.png" alt="load profile pct 数据集产生的透视图"></p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul><li><strong>结果集为快照间load profile 指标间累积差的占比(百分比)</strong></li><li><strong>脚本已经在oracle 11.2.0.1、11.2.0.4单实例和RAC环境下通过测试</strong></li></ul><h3 id="脚本文件"><a href="#脚本文件" class="headerlink" title="脚本文件"></a>脚本文件</h3><p><a href="/files/awr_load_profile_pct.sql">点击下载</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.enmotech.com/web/detail/1/330/2.html" rel="external nofollow noopener noreferrer" target="_blank">SQL玩转AWR裸数据-云和恩墨</a><br><a href="http://qkxue.net/info/181928/Oracle-AWR" rel="external nofollow noopener noreferrer" target="_blank">循序渐进解读Oracle AWR性能分析报告</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;当我们使用前面介绍的&lt;a href=&quot;/posts/51016/&quot;&gt;Script—元数据获取load profile报告&lt;/
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/categories/Database/Oracle/Script/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/tags/Script/"/>
    
      <category term="AWR" scheme="http://mapele.coding.me/tags/AWR/"/>
    
  </entry>
  
  <entry>
    <title>Script—元数据获取load profile报告</title>
    <link href="http://mapele.coding.me/posts/51016/"/>
    <id>http://mapele.coding.me/posts/51016/</id>
    <published>2018-06-21T03:32:03.000Z</published>
    <updated>2019-05-14T08:13:32.281Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><strong>DBA往往需要在数据库性能问题的时候快速获取数据库负载信息，而AWR此时通常作为最有效的工具之一，虽然AWR很优秀，但是众所周知也存在一些缺陷，主要体现在如下两方面：</strong></p><ul><li><strong>内容繁多，用时较长</strong></li><li><strong>AWR统计的是begin_snap、end_snap两个快照间间累积差异，在这之间每个快照间的变化无法体现</strong></li></ul><p><strong>大家都知道AWR报告也都来源于数据库相关视图，因此只要我们弄清楚这些元数据的关系，就能按照我们自己的意愿组织我们自己所最关心的报告数据。</strong></p><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p><em>如下，这是自己参考相关资料总结的load profile报告脚本，如果有需要可以通过下文的链接下载</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line">-- |                            runanyun Mapele                               |</div><div class="line">-- |                            wuyu.xiao@gmail.com                             |</div><div class="line">-- |             http://mapele.coding.me/ &amp;&amp; http://mapele.github.io/           |</div><div class="line">-- |----------------------------------------------------------------------------|</div><div class="line">-- | DATABASE : Oracle 11g(RAC)                                                 |</div><div class="line">-- | FILE     : awr_load_profile.sql                                            |</div><div class="line">-- | PURPOSE  : 通过裸数据获取AWR中连续快照间的load profile报告.                   |</div><div class="line">-- +----------------------------------------------------------------------------+</div><div class="line"></div><div class="line">WHENEVER SQLERROR EXIT SQL.SQLCODE</div><div class="line"></div><div class="line">SET VER OFF</div><div class="line">set LINESIZE 200</div><div class="line">SET FEEDBACK OFF</div><div class="line"></div><div class="line">COLUMN INST_NO       FORMAT 99              HEADING &apos;INSNO&apos;</div><div class="line">COLUMN SNAP_ID       FORMAT 99999</div><div class="line">COLUMN &quot;DB time&quot;     FORMAT 999,999,999,999</div><div class="line">COLUMN &quot;DB CPU&quot;      FORMAT 9,999,999,999</div><div class="line">COLUMN Redo          FORMAT 999,999,999</div><div class="line">COLUMN LogicalR      FORMAT 99,999,999 </div><div class="line">COLUMN BlockChs      FORMAT 99,999,999</div><div class="line">COLUMN Phyr          FORMAT 99,999 </div><div class="line">COLUMN Phyw          FORMAT 9,999,999</div><div class="line">COLUMN Calls         FORMAT 9,999,999</div><div class="line">COLUMN Parses        FORMAT 999,999</div><div class="line">COLUMN HParses       FORMAT 9,999</div><div class="line">COLUMN Logons        FORMAT 999,999</div><div class="line">COLUMN Execs         FORMAT 9,999,999</div><div class="line">COLUMN Rbacks        FORMAT 9,999</div><div class="line">COLUMN Trans         FORMAT 999,999</div><div class="line"></div><div class="line">PROMPT</div><div class="line">BREAK ON INST_NO skip page</div><div class="line"></div><div class="line">ACCEPT DAYS  NUMBER PROMPT &quot;ENTER latest snap days: &quot; default 7</div><div class="line"></div><div class="line">SELECT INSTANCE_NUMBER INST_NO,</div><div class="line">       SNAP_ID, </div><div class="line">   TO_CHAR(BEGIN_INTERVAL_TIME,&apos;YYYY-MM-DD HH24:MI:SS&apos;) BEGIN_INTERVAL_TIME</div><div class="line">  FROM DBA_HIST_SNAPSHOT</div><div class="line"> WHERE BEGIN_INTERVAL_TIME &gt; TRUNC(SYSDATE) - &amp;DAYS</div><div class="line"> ORDER BY INSTANCE_NUMBER,BEGIN_INTERVAL_TIME;</div><div class="line"></div><div class="line">PROMPT </div><div class="line"></div><div class="line">ACCEPT INST_NO    NUMBER PROMPT &quot;ENTER INSTANCE_NUMBER: &quot; default 0</div><div class="line">ACCEPT BEGIN_SNAP    NUMBER PROMPT &quot;ENTER BEGIN_SNAP: &quot;</div><div class="line">ACCEPT END_SNAP      NUMBER PROMPT &quot;ENTER END_SNAP: &quot;</div><div class="line"></div><div class="line">PROMPT</div><div class="line">PROMPT Listing load profile by instance no and snap id ...</div><div class="line"></div><div class="line">SELECT *</div><div class="line">  FROM (SELECT TO_CHAR(HS.BEGIN_INTERVAL_TIME, &apos;mmdd hh24mi&apos;) SNAP_TIME</div><div class="line">              ,S.*</div><div class="line">          FROM (SELECT T.INSTANCE_NUMBER INST_NO</div><div class="line">                      ,T.SNAP_ID - 1 SNAP_ID</div><div class="line">                      ,STAT_NAME</div><div class="line">                      ,NVL(VALUE - LAG(VALUE)</div><div class="line">                           OVER(PARTITION BY T.INSTANCE_NUMBER</div><div class="line">                               ,STAT_NAME ORDER BY T.INSTANCE_NUMBER</div><div class="line">                               ,T.SNAP_ID)</div><div class="line">                          ,0) VALUE</div><div class="line">                  FROM DBA_HIST_SYS_TIME_MODEL T</div><div class="line">                 WHERE INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                   AND STAT_NAME IN (&apos;DB time&apos;, &apos;DB CPU&apos;)</div><div class="line">                UNION ALL</div><div class="line">                SELECT T.INSTANCE_NUMBER INST</div><div class="line">                      ,T.SNAP_ID - 1 SNAP_ID</div><div class="line">                      ,STAT_NAME</div><div class="line">                      ,NVL(VALUE - LAG(VALUE)</div><div class="line">                           OVER(PARTITION BY T.INSTANCE_NUMBER</div><div class="line">                               ,STAT_NAME ORDER BY T.INSTANCE_NUMBER</div><div class="line">                               ,T.SNAP_ID)</div><div class="line">                          ,0) VALUE</div><div class="line">                  FROM DBA_HIST_SYSSTAT T</div><div class="line">                 WHERE INSTANCE_NUMBER= CASE WHEN &amp;INST_NO = 0 THEN INSTANCE_NUMBER ELSE &amp;INST_NO END</div><div class="line">   AND SNAP_ID BETWEEN &amp;BEGIN_SNAP AND &amp;END_SNAP</div><div class="line">                   AND STAT_NAME IN (&apos;redo size&apos;</div><div class="line">                                    ,&apos;session logical reads&apos;</div><div class="line">                                    ,&apos;db block changes&apos;</div><div class="line">                                    ,&apos;physical reads&apos;</div><div class="line">                                    ,&apos;physical writes&apos;</div><div class="line">                                    ,&apos;user calls&apos;</div><div class="line">                                    ,&apos;parse count (total)&apos;</div><div class="line">                                    ,&apos;parse count (hard)&apos;</div><div class="line">                                    ,&apos;logons cumulative&apos;</div><div class="line">                                    ,&apos;execute count&apos;</div><div class="line">                                    ,&apos;user rollbacks&apos;</div><div class="line">                                    ,&apos;user commits&apos;)) S</div><div class="line">              ,DBA_HIST_SNAPSHOT HS</div><div class="line">         WHERE S.SNAP_ID = HS.SNAP_ID</div><div class="line">   AND S.SNAP_ID != &amp;BEGIN_SNAP-1)</div><div class="line">PIVOT(SUM(VALUE)</div><div class="line">   FOR STAT_NAME IN(&apos;DB time&apos; AS &quot;DB time&quot;</div><div class="line">                    ,&apos;DB CPU&apos; AS &quot;DB CPU&quot;</div><div class="line">                    ,&apos;redo size&apos; AS &quot;Redo&quot;</div><div class="line">                    ,&apos;session logical reads&apos; AS &quot;LogicalR&quot;</div><div class="line">                    ,&apos;db block changes&apos; AS &quot;BlockChs&quot;</div><div class="line">                    ,&apos;physical reads&apos; AS &quot;Phyr&quot;</div><div class="line">                    ,&apos;physical writes&apos; AS &quot;Phyw&quot;</div><div class="line">                    ,&apos;user calls&apos; AS &quot;Calls&quot;</div><div class="line">                    ,&apos;parse count (total)&apos; AS &quot;Parses&quot;</div><div class="line">                    ,&apos;parse count (hard)&apos; AS &quot;HParses&quot;</div><div class="line">                    ,&apos;logons cumulative&apos; AS &quot;Logons&quot;</div><div class="line">                    ,&apos;execute count&apos; AS &quot;Execs&quot;</div><div class="line">                    ,&apos;user rollbacks&apos; AS &quot;Rbacks&quot;</div><div class="line">                    ,&apos;user commits&apos; AS &quot;Trans&quot;))</div><div class="line"> ORDER BY INST_NO</div><div class="line">         ,SNAP_TIME;</div></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2019/05/14/5cda77b1a68d124578.png" alt="load profile报告"></p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul><li><strong>结果集为快照间load profile 指标间的累积差</strong></li><li><strong>DB time、DB CPU 单位为微妙</strong></li><li><strong>Redo、 LogicalR、BlockChs、Phyr、Phyw 单位为块数，计算实际大小时别忘记db_block_size</strong></li><li><strong>剩余指标单位皆为次数</strong></li><li><strong>脚本已经在oracle 11.2.0.1、11.2.0.4单实例和RAC环境下通过测试</strong></li></ul><h3 id="脚本文件"><a href="#脚本文件" class="headerlink" title="脚本文件"></a>脚本文件</h3><p><a href="/files/awr_load_profile.sql">点击下载</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.enmotech.com/web/detail/1/330/2.html" rel="external nofollow noopener noreferrer" target="_blank">SQL玩转AWR裸数据-云和恩墨</a><br><a href="http://qkxue.net/info/181928/Oracle-AWR" rel="external nofollow noopener noreferrer" target="_blank">循序渐进解读Oracle AWR性能分析报告</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;DBA往往需要在数据库性能问题的时候快速获取数据库负载信息，而AWR此时通常作为最有效的工具之一，虽然AWR很优秀，但是众所
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/categories/Database/Oracle/Script/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="Script" scheme="http://mapele.coding.me/tags/Script/"/>
    
      <category term="AWR" scheme="http://mapele.coding.me/tags/AWR/"/>
    
  </entry>
  
  <entry>
    <title>Linux配置Mysql5.7.9主-从、主-主同步</title>
    <link href="http://mapele.coding.me/posts/29746/"/>
    <id>http://mapele.coding.me/posts/29746/</id>
    <published>2014-01-07T09:30:02.000Z</published>
    <updated>2019-08-08T05:16:26.216Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> <em>上一篇学着在Linux下编译安装Mysql5.7.9，刚好有时间，在此基础上搭建一下Mysql的主从、主主同步！</em></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul><li><p><strong>Master</strong>：</p><p>  Linux发行版本： Oracle Linux Server release 6.5</p><p>  Os版本：    3.8.13-98.4.1.el6uek.x86_64</p><p>  Host： 192.168.1.253</p></li><li><p><strong>Slave</strong>：</p><p>  Linux发行版本： CentOS release 6.6 (Final)</p><p>  Os版本：2.6.32-504.el6.x86_64</p><p>  Host： 192.168.1.225</p></li></ul><h3 id="Slave数据库安装"><a href="#Slave数据库安装" class="headerlink" title="Slave数据库安装"></a>Slave数据库安装</h3><p>参见：<a href="https://mapele.github.io/posts/37101/" rel="external nofollow noopener noreferrer" target="_blank">Linux编译安装Mysql5.7.9 | 57°极客闷烧</a></p><h3 id="Master配置"><a href="#Master配置" class="headerlink" title="Master配置"></a>Master配置</h3><p>在my.cnf中添加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">server-id=1</div><div class="line">log-bin=mysql-bin</div><div class="line">binlog_format=&quot;ROW&quot;</div><div class="line">max_binlog_size = 500M </div><div class="line">binlog_cache_size = 128K </div><div class="line">binlog-do-db = xwy </div><div class="line">binlog-ignore-db = mysql </div><div class="line">log-slave-updates </div><div class="line">expire_logs_day=2</div></pre></td></tr></table></figure></p><p><strong>参数说明：</strong></p><p><strong>server-id:</strong><br>主从复制中标识不同的主机<br><strong>log-bin:</strong><br>开启二进制日志，默认存在Mysql数据文件目录下,文件名以此为前缀，如mysql-bin.000001；默认大小1G<br><strong>binlog_format:</strong><br>日志格式，有SATEMENT、ROW、MIXED三个选项，对应复制模式：SBR、RBR、MBR.详细说明可参考：<a href="http://blog.liudongkai.com/2012/03/02/mysql-binlog-format/" rel="external nofollow noopener noreferrer" target="_blank">MYSQL复制参数binlog_format | Dong‘s Note</a><br><strong>max_binlog_size:</strong><br>每个bin-log最大大小，当此大小等于500M时会自动生成一个新的日志文件。一条记录不会写在2个日志文件中，所以有时日志文件会超过此大小。<br><strong>binlog_cache_size:</strong><br>日志缓存大小<br><strong>binlog-do-db:</strong><br>需要同步的数据库名字，如果是多个，就以此格式在写一行即可。<br><strong>binlog-ignore-db:</strong><br>不需要同步的数据库名字，如果是多个，就以此格式在写一行即可。<br><strong>log-slave-updates:</strong><br>当Slave从Master数据库读取日志时更新新写入日志中，如果只启动log-bin 而没有启动log-slave-updates则Slave只记录针对自己数据库操作的更新。<br><strong>expire_logs_day:</strong><br>设置bin-log日志文件保存的天数，此参数mysql5.0以下版本不支持。</p><h3 id="Slave配置"><a href="#Slave配置" class="headerlink" title="Slave配置"></a>Slave配置</h3><p>在my.cnf中添加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">[mysqld]           </div><div class="line">server-id=2</div><div class="line"></div><div class="line">#binlog</div><div class="line"></div><div class="line">log-bin=mysql-bin</div><div class="line">binlog_format=ROW</div><div class="line">#binlog-row-image = minimal</div><div class="line">#gtid_mode = ON</div><div class="line">#enforce-gtid-consistency = true</div><div class="line">binlog_cache_size = 4M</div><div class="line">max_binlog_size = 500M</div><div class="line">max_binlog_cache_size = 500M</div><div class="line">sync_binlog = 1</div><div class="line">replicate-do-db = xwy</div><div class="line">replicate-ignore-db = mysql</div><div class="line">replicate_do_table=t_xwy</div><div class="line">replicate_ignore_iable=t_test</div><div class="line">master-connect-retry=30</div><div class="line">slave-skip-errors = 1062</div><div class="line">expire_logs_days = 3</div><div class="line">skip-slave-start=1</div><div class="line">slave_net_timeout=20</div><div class="line">slave_parallel_workers = 0 </div><div class="line">read-only =0 </div><div class="line"></div><div class="line">#relay log</div><div class="line">relay-log=/home/tools/mysql/data/relay.log #设置中继日志文件基本名</div><div class="line">max_relay_log_size = 500M</div><div class="line"></div><div class="line">#以下两个是启用relaylog的自动修复功能，避免由于网络之类的外因造成日志损坏，主从停止。</div><div class="line">relay_log_purge = 1</div><div class="line">relay_log_recovery = 1</div><div class="line"></div><div class="line">#以下四个参数是启用binlog/relaylog的校验，防止日志出错</div><div class="line">binlog_checksum = CRC32</div><div class="line">slave_allow_batching = 1</div><div class="line">master_verify_checksum = 1</div><div class="line">slave_sql_verify_checksum = 1</div><div class="line">binlog_rows_query_log_events = 1</div><div class="line"></div><div class="line">#以下两个参数会将master.info和relay.info保存在表中，默认是Myisam引擎，官方建议用</div><div class="line">#master_info_repository = TABLE</div><div class="line">#relay_log_info_repository = TABLE</div><div class="line">log_slave_updates</div></pre></td></tr></table></figure></p><p><strong>参数说明：</strong></p><p><strong>binlog-row-image:</strong><br>这个选项允许应用程序只能对行的镜像数据进行复制，而不在关心行是否已经进行了DML操作。这提高了主从机器的复制吞吐量，减少了二进制日志所占用的磁盘空间、网络资源和内存占用。<br><strong>replicate-do-db</strong>:<br>复制的db<br><strong>replicate-ignore-db:</strong><br>忽略复制的db<br><strong>replicate_do_table:</strong><br>设定需要复制的Table<br><strong>replicate_ignore_iable:</strong><br>设定可以忽略的Table<br><strong>master-connect-retry:</strong><br>这个选项控制重试间隔，默认为60秒。<br><strong>slave-skip-errors:</strong><br>同步过程中忽略掉的错误，如果有多个用逗号隔开。这些错误不会影响数据的完整性，有事经常出现的错误，一般设置忽略。其中1062为主键重复错误。<br><strong>expire_logs_days:</strong><br>设置bin-log日志文件保存的天数，此参数mysql5.0以下版本不支持。<br><strong>skip-slave-start:</strong><br>动从库但不立即启动从库的复制进程，以便对从库进行进一步的设置。<br><strong>slave_net_timeout:</strong><br>设置网络超时时间，即多长时间测试一下主从是否连接，默认为3600秒。<br><strong>slave_parallel_workers:</strong><br>默认是0，不开启，最大并发数为1024个线程。主从复制启用4个sql线程，提高从服务器吞吐量，减少延迟,使用并发的 SQL 线程对不同数据库并行应用事件，如果只同步一个库的，指定为0，否则会阻塞。<br><strong>read-only:</strong><br>设置Slave为只读，但具有super权限的用户仍然可写。主主复制时必须关闭。<br><strong>log_slave_updates：</strong><br>该参数用来控制Slave上的更新是否写入二进制日志，默认为0；若Slave只作为从服务器，则不必启用；若Slave作为其他服务器的Master，则需启用，启用时需和log-bin、binlog-format一起使用，这样Slave从主库读取日志并重做，然后记录到自己的二进制日志中.</p><h3 id="Mater创建复制用户"><a href="#Mater创建复制用户" class="headerlink" title="Mater创建复制用户"></a>Mater创建复制用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; GRANT REPLICATION SLAVE on *.* to &apos;slave&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos;;</div></pre></td></tr></table></figure><h3 id="Mater备份数据"><a href="#Mater备份数据" class="headerlink" title="Mater备份数据"></a>Mater备份数据</h3><h4 id="锁表"><a href="#锁表" class="headerlink" title="锁表"></a>锁表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; flush tables with read lock;</div></pre></td></tr></table></figure><h4 id="获取日志及偏移量"><a href="#获取日志及偏移量" class="headerlink" title="获取日志及偏移量"></a>获取日志及偏移量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| mysql-bin.000020 |      194 |              |                  | 44c86870-999c-11e5-b608-08002718c663:1-3 |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div></pre></td></tr></table></figure><h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># mysqldump -uroot -pmyroot --all-database </div><div class="line">&gt;/home/mysql/data/dbback.sql;</div></pre></td></tr></table></figure><h4 id="恢复写操作"><a href="#恢复写操作" class="headerlink" title="恢复写操作"></a>恢复写操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; unlock tables;</div></pre></td></tr></table></figure><h3 id="Slave同步"><a href="#Slave同步" class="headerlink" title="Slave同步"></a>Slave同步</h3><h4 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -pmyroot &lt;/home/mysql/data/dbback.sql</div></pre></td></tr></table></figure><h4 id="同步设置"><a href="#同步设置" class="headerlink" title="同步设置"></a>同步设置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; slave stop;</div><div class="line">mysql&gt; reset slave;</div><div class="line">mysql&gt; change master to</div><div class="line">-&gt; master_host=&apos;192.168.1.253&apos;,</div><div class="line">-&gt; master_user=&apos;slave&apos;,</div><div class="line">-&gt; master_password=&apos;123456&apos;,</div><div class="line">-&gt; master_log_file=&apos;mysql-bin.000020&apos;,</div><div class="line">-&gt; master_log_pos=194;</div></pre></td></tr></table></figure><h4 id="启动同步线程"><a href="#启动同步线程" class="headerlink" title="启动同步线程"></a>启动同步线程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; start slave;</div></pre></td></tr></table></figure><h4 id="查看slave状态"><a href="#查看slave状态" class="headerlink" title="查看slave状态"></a>查看slave状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show slave status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting for master to send event</div><div class="line">                  Master_Host: 192.168.1.225</div><div class="line">                  Master_User: slave</div><div class="line">                  Master_Port: 3306</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: mysql-bin.000020</div><div class="line">          Read_Master_Log_Pos: 154</div><div class="line">               Relay_Log_File: new-relay-bin.000006</div><div class="line">                Relay_Log_Pos: 367</div><div class="line">        Relay_Master_Log_File: mysql-bin.000020</div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB: </div><div class="line">          Replicate_Ignore_DB: </div><div class="line">           Replicate_Do_Table: </div><div class="line">       Replicate_Ignore_Table: </div><div class="line">      Replicate_Wild_Do_Table: </div><div class="line">  Replicate_Wild_Ignore_Table: </div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error: </div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 154</div><div class="line">              Relay_Log_Space: 785</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File: </div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: No</div><div class="line">           Master_SSL_CA_File: </div><div class="line">           Master_SSL_CA_Path: </div><div class="line">              Master_SSL_Cert: </div><div class="line">            Master_SSL_Cipher: </div><div class="line">               Master_SSL_Key: </div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error: </div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error: </div><div class="line">  Replicate_Ignore_Server_Ids: </div><div class="line">             Master_Server_Id: 2</div><div class="line">                  Master_UUID: aaf502d8-a886-11e5-a976-08002787c6af</div><div class="line">             Master_Info_File: /home/mysql/data/master.info</div><div class="line">                    SQL_Delay: 0</div><div class="line">          SQL_Remaining_Delay: NULL</div><div class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</div><div class="line">           Master_Retry_Count: 86400</div><div class="line">                  Master_Bind: </div><div class="line">      Last_IO_Error_Timestamp: </div><div class="line">     Last_SQL_Error_Timestamp: </div><div class="line">               Master_SSL_Crl: </div><div class="line">           Master_SSL_Crlpath: </div><div class="line">           Retrieved_Gtid_Set: </div><div class="line">            Executed_Gtid_Set: 44c86870-999c-11e5-b608-08002718c663:1-3</div><div class="line">                Auto_Position: 0</div><div class="line">         Replicate_Rewrite_DB: </div><div class="line">                 Channel_Name:</div></pre></td></tr></table></figure><p><strong>说明：</strong></p><p><strong>Slave_IO_Running</strong>――此进程负责从Slave从Master上读取binlog日志，并写入Slave上的中继日志。</p><p><strong>Slave_SQL_Running</strong>――此进程负责读取并执行中继日志中的binlog日志。<br>这两个进程的状态需全部为YES，只要有一个为NO，则复制就会停止。</p><p>当Slave中<strong>Relay_Master_Log_File</strong>和M<strong>aster_Log_File</strong>相同且<strong>Read_Master_Log_Pos</strong>和<strong>Exec_Master_Log_Pos</strong>完全相同时，则表明Slave和Master处于完全同步的状态。</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Master上:</div><div class="line">create database xwy;</div><div class="line">create table xwy.test (id int,name varchar(200));</div><div class="line">insert into xwy.test values (1,&apos;xwy&apos;);</div><div class="line">insert into xwy.test values (2,&apos;xwy&apos;);</div><div class="line">select * from xwy.test;</div><div class="line">Slave上:</div><div class="line">use xwy;</div><div class="line">select * from xwy.test;</div></pre></td></tr></table></figure><p>观察两边结果是否一致。</p><h3 id="Slave修改启动开启同步进程"><a href="#Slave修改启动开启同步进程" class="headerlink" title="Slave修改启动开启同步进程"></a>Slave修改启动开启同步进程</h3><p>注释掉配置文件my.cnf中的skip-slave-start=1 or skip-slave-start=true</p><h3 id="添加新的Slave"><a href="#添加新的Slave" class="headerlink" title="添加新的Slave"></a>添加新的Slave</h3><p>原理跟添加第一台Slave一样，修改配置文件my.cnf中的server-id=3,就可以啦。</p><h3 id="主主复制"><a href="#主主复制" class="headerlink" title="主主复制"></a>主主复制</h3><p>只需要将Slave配置中相关参数添加到Master中即可。注意因为双方需要复制更新，因此记得关闭my.cnf中的read-only =1为read-only =0，并开启log_slave_updates（slave更新写入bin-log）.</p><h3 id="常见错误及处理"><a href="#常见错误及处理" class="headerlink" title="常见错误及处理"></a>常见错误及处理</h3><h4 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h4><p><strong>现象</strong></p><pre><code>在从库上面show slave status\G;显示:Slave_IO_Running: YesSlave_SQL_Running: NoSeconds_Behind_Master: NULL</code></pre><p><strong>原因</strong></p><p><strong>a.</strong>程序可能在slave上进行了写操作；</p><p><strong>b.</strong>也可能是slave机器重起后，事务回滚造成的；</p><p><strong>c.</strong>有可能是在同步过程中遇到某种错误，这个会在查看从库中状态时看到错误提示，最少见的就是主键重复1062的错误。</p><p><strong>解决方法</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Master:</div><div class="line">mysql&gt; show master status;</div><div class="line"></div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| mysql-bin.000021 |      102 |              |                  | 44c86870-999c-11e5-b608-08002718c663:1-3 |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line"></div><div class="line">Slave:</div><div class="line">mysql&gt; slave stop;</div><div class="line">mysql&gt; change master to</div><div class="line">-&gt; master_host=&apos;192.168.1.253&apos;,</div><div class="line">    -&gt; master_user=&apos;slave&apos;,</div><div class="line">    -&gt; master_password=&apos;123456&apos;,</div><div class="line">-&gt; master_log_file=&apos;mysql-bin.000021&apos;,</div><div class="line">    -&gt; master_log_pos=102;</div><div class="line">mysql&gt; slave start;</div></pre></td></tr></table></figure></p><h4 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h4><p><strong>现象</strong></p><p>从数据库无法同步</p><p>在从库上面show slave status\G;显示:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">show slave status\G;</div><div class="line">Slave_IO_Running: No</div><div class="line">Slave_SQL_Running: Yes</div><div class="line">Seconds_Behind_Master: NULL</div></pre></td></tr></table></figure></p><p><strong>原因</strong></p><p>这个现象主要是master数据库存在问题，由于连接主库信息错误、主库数据库挂掉如果说常见错等原因引起的，我在实际的操作中先重启master后重启slave即可解决这问题，出现此问题，必须要要重启master数据库。</p><p><strong>解决</strong></p><p>首先查看数据库的err日志，查看是什么错误提示，看从库连接主库的IP、用户、密码等相关信息是否有误，如果有误，重新执行同步；如果确认无误，重启主数据库。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Master:</div><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">| mysql-bin.000001 |      94 |              |                  | 44c86870-999c-11e5-b608-08002718c663:1-3 |</div><div class="line">+------------------+----------+--------------+------------------+------------------------------------------+</div><div class="line">Slave:</div><div class="line">mysql&gt; slave stop;</div><div class="line">mysql&gt; change master to</div><div class="line">-&gt; master_log_file=&apos;mysql-bin.000001&apos;,</div><div class="line">-&gt; master_log_pos=94;</div><div class="line">mysql&gt; slave start;</div><div class="line">或：</div><div class="line">mysql&gt; slave stop;</div><div class="line">mysql&gt; set global sql_slave_skip_counter =1;</div><div class="line">mysql&gt; slave start;</div></pre></td></tr></table></figure></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.sae.sina.com.cn/archives/4666" rel="external nofollow noopener noreferrer" target="_blank">Mysql数据库主从心得整理 | Sina App Engine Blog</a><br><a href="http://clear.vimge.com/archives/mysql/mysql-seconds_behind_master.html" rel="external nofollow noopener noreferrer" target="_blank">MySQL同步参数Seconds_Behind_Master=0 并不能确定主从是否延时 – WEB·攻城志</a><br><a href="http://blog.itpub.net/12679300/viewspace-1320872/" rel="external nofollow noopener noreferrer" target="_blank">mysql relay log参数汇总-wzq609-ITPUB博客</a><br><a href="http://blog.csdn.net/tanweii163/article/details/50245609" rel="external nofollow noopener noreferrer" target="_blank">mysql5.7.9主从同步配置 - tanweii163的专栏 - 博客频道 - CSDN.NET</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt; &lt;em&gt;上一篇学着在Linux下编译安装Mysql5.7.9，刚好有时间，在此基础上搭建一下Mysql的主从、主主同步！&lt;/em&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Mysql" scheme="http://mapele.coding.me/categories/Database/Mysql/"/>
    
      <category term="HA" scheme="http://mapele.coding.me/categories/Database/Mysql/HA/"/>
    
    
      <category term="mysql" scheme="http://mapele.coding.me/tags/mysql/"/>
    
      <category term="HA" scheme="http://mapele.coding.me/tags/HA/"/>
    
  </entry>
  
  <entry>
    <title>Linux编译安装Mysql5.7.9</title>
    <link href="http://mapele.coding.me/posts/37101/"/>
    <id>http://mapele.coding.me/posts/37101/</id>
    <published>2013-12-28T07:03:45.000Z</published>
    <updated>2017-09-10T14:38:08.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> <em>Linux下默认安装mysql会在默认目录安装生成相关文件，可配置性差，当然也可以下载免安装版，但总的来说实在不能随心所欲。正好，此前从未进行过编译方式安装mysql，正好练手。期间报错无数，查询无数前辈总结总算安装完成。因未记录引用地址，此处无法说明感谢，如有雷同，并非巧合！</em> </p><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install gcc gcc-c++ ncurses ncurses-devel cmake autoconf automake zlib libxml libgcrypt libtool bison</div></pre></td></tr></table></figure><h3 id="清理已经存在的mysql"><a href="#清理已经存在的mysql" class="headerlink" title="清理已经存在的mysql"></a>清理已经存在的mysql</h3><h4 id="查询mysql安装"><a href="#查询mysql安装" class="headerlink" title="查询mysql安装"></a>查询mysql安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -qa | grep -i mysql</div></pre></td></tr></table></figure><h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -e</div></pre></td></tr></table></figure><h4 id="查询mysql服务"><a href="#查询mysql服务" class="headerlink" title="查询mysql服务"></a>查询mysql服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig --list | grep -i mysql</div></pre></td></tr></table></figure><h4 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig --list | grep -i mysql</div></pre></td></tr></table></figure><h4 id="mysql分散文件查询及删除"><a href="#mysql分散文件查询及删除" class="headerlink" title="mysql分散文件查询及删除"></a>mysql分散文件查询及删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">whereis mysql</div><div class="line">rm -rf</div></pre></td></tr></table></figure><h3 id="下载源码包、解压并安装bootst"><a href="#下载源码包、解压并安装bootst" class="headerlink" title="下载源码包、解压并安装bootst"></a>下载源码包、解压并安装bootst</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cd ~/Download</div><div class="line">wget http://downloads.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz</div><div class="line">wget http://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.9.tar.gz</div><div class="line">tar xzf boost_1_59_0.tar.gz</div><div class="line">tar xzf mysql-5.7.9.tar.gz</div><div class="line">cd boost_1_59_0</div><div class="line">./bootstrap.sh</div><div class="line">./b2 stage threading=multi link=shared</div><div class="line">./b2 install threading=multi link=shared</div></pre></td></tr></table></figure><h3 id="创建mysql用户、组、mysql安装目录、数据文件目录拥有者及权限"><a href="#创建mysql用户、组、mysql安装目录、数据文件目录拥有者及权限" class="headerlink" title="创建mysql用户、组、mysql安装目录、数据文件目录拥有者及权限"></a>创建mysql用户、组、mysql安装目录、数据文件目录拥有者及权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">groupadd -r mysql</div><div class="line">useradd -r -g mysql -s /sbin/nologin -M mysql</div><div class="line">mkdir -p /home/mysql/data</div><div class="line">chown -R root:mysql /home/mysql &amp;&amp; chown -R mysql:mysql /home/mysql/data &amp;&amp; chmod -R 755 /home/mysql/data</div></pre></td></tr></table></figure><h3 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cd mysql-5.7.9</div><div class="line">cmake . -DCMAKE_INSTALL_PREFIX=/home/mysql \  #MySQL安装的根目录，默认/usr/local/mysql</div><div class="line">-DMYSQL_DATADIR=/home/mysql/data \            #MySQL数据库文件存放目录</div><div class="line">-DDOWNLOAD_BOOST=1 \                          #启用BOOST库从MySQL 5.7.5开始Boost库是必需的</div><div class="line">-DWITH_BOOST=/usr/local/include \             #BOOST库地址</div><div class="line">-DSYSCONFDIR=/home/mysql \                    #MySQL配置文件目录</div><div class="line">-DMYSQL_USER=mysql \</div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</div><div class="line">-DENABLED_LOCAL_INFILE=1 \                   #指定是否允许本地执行LOAD DATA INFILE，默认OFF</div><div class="line">-DENABLE_DTRACE=0 \</div><div class="line">-DWITH_SSL=bundled \                         #Centos需要</div><div class="line">-DDEFAULT_CHARSET=utf8 \                     #MySQL缺省字符集，默认latin1</div><div class="line">-DDEFAULT_COLLATION=utf8_general_ci \        #MySQL缺省的校对规则，默认latin1_general_ci</div><div class="line">-DWITH_EMBEDDED_SERVER=1</div></pre></td></tr></table></figure><h3 id="编译并安装"><a href="#编译并安装" class="headerlink" title="编译并安装"></a>编译并安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">make -j `grep processor /proc/cpuinfo | wc -l`</div><div class="line">make install</div><div class="line">如果出错，重新运行配置，需要删除CMakeCache.txt 文件</div><div class="line">make clean</div><div class="line">rm -f CMakeCache.txt</div></pre></td></tr></table></figure><h3 id="设置配置"><a href="#设置配置" class="headerlink" title="设置配置"></a>设置配置</h3><h4 id="复制配置文件并加入以下参数"><a href="#复制配置文件并加入以下参数" class="headerlink" title="复制配置文件并加入以下参数"></a>复制配置文件并加入以下参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">cp /home/mysql/support-files/my-default.cnf /home/mysql/my.cnf</div><div class="line">vim /home/mysql/my.cnf</div><div class="line">    basedir = /home/mysql</div><div class="line">datadir = /home/mysql/data</div><div class="line">pid_file = /home/mysql/mysql.pid</div><div class="line">log_error = /home/mysql/mysql.log</div><div class="line">port = 3306</div><div class="line">character_set_server = utf8</div><div class="line">explicit_defaults_for_timestamp=true</div><div class="line"></div><div class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,</div><div class="line">NO_AUTO_CREATE_USER</div><div class="line">    show_compatibility_56=ON</div></pre></td></tr></table></figure><h3 id="复制启动文件"><a href="#复制启动文件" class="headerlink" title="复制启动文件"></a>复制启动文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp /home/mysql/support-files/mysql.server /etc/init.d/mysqld</div></pre></td></tr></table></figure><h3 id="添加执行权限及自动启动服务"><a href="#添加执行权限及自动启动服务" class="headerlink" title="添加执行权限及自动启动服务"></a>添加执行权限及自动启动服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">chmod +x /etc/init.d/mysqld</div><div class="line">chkconfig --list mysqld</div><div class="line">chkconfig --add mysqld</div><div class="line">chkconfig --level 345 mysqld on</div></pre></td></tr></table></figure><h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vim ~/.bash_profile</div><div class="line">    PATH=/home/mysql/bin:$PATH</div></pre></td></tr></table></figure><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/mysql/bin/mysqld --initialize --user=mysql --basedir=/home/mysql --datadir=/home/mysql/data</div></pre></td></tr></table></figure><p><em>此命令会在日志文件/home/mysql/mysql.log中生成密码</em></p><h3 id="启动mysql服务及检查"><a href="#启动mysql服务及检查" class="headerlink" title="启动mysql服务及检查"></a>启动mysql服务及检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -ef | grep mysqll &amp;&amp; netstat -tunpl | grep 3306</div></pre></td></tr></table></figure><h3 id="修改root默认密码及配置远程访问"><a href="#修改root默认密码及配置远程访问" class="headerlink" title="修改root默认密码及配置远程访问"></a>修改root默认密码及配置远程访问</h3><pre><code>mysql -u root -p重置密码mysql&gt; SET PASSWORD = PASSWORD(&apos;myroot&apos;); 或/home/mysql/bin/mysqladmin -u root -p password设置root用户远程访问mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;myroot&apos; with grant option;</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt; &lt;em&gt;Linux下默认安装mysql会在默认目录安装生成相关文件，可配置性差，当然也可以下载免安装版，但总的来说实在不能随心所欲。正好，
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Mysql" scheme="http://mapele.coding.me/categories/Database/Mysql/"/>
    
      <category term="Install" scheme="http://mapele.coding.me/categories/Database/Mysql/Install/"/>
    
    
      <category term="install" scheme="http://mapele.coding.me/tags/install/"/>
    
      <category term="mysql" scheme="http://mapele.coding.me/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Oracle11gR2 RAC配置单实例DG On CentOS6.5</title>
    <link href="http://mapele.coding.me/posts/43685/"/>
    <id>http://mapele.coding.me/posts/43685/</id>
    <published>2013-10-05T12:11:54.000Z</published>
    <updated>2019-08-08T09:47:01.517Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><em>最近项目要求给生产环境中的RAC数据库配置DG,过程中遇到不少问题，以此记录，避免同一个问题犯二。</em></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><h4 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h4><table><thead><tr><th style="text-align:center">node</th><th style="text-align:center">instance_name</th><th style="text-align:center">db_name</th><th style="text-align:center">db_unique_name</th><th style="text-align:center">IP</th></tr></thead><tbody><tr><td style="text-align:center">rac1</td><td style="text-align:center">wwlc1</td><td style="text-align:center">wwlc</td><td style="text-align:center">wwlc</td><td style="text-align:center">192.168.66.66</td></tr><tr><td style="text-align:center">rac2</td><td style="text-align:center">wwlc2</td><td style="text-align:center">wwlc</td><td style="text-align:center">wwlc</td><td style="text-align:center">192.168.66.88</td></tr></tbody></table><h4 id="备库"><a href="#备库" class="headerlink" title="备库"></a>备库</h4><table><thead><tr><th style="text-align:center">instance_name</th><th style="text-align:center">db_name</th><th style="text-align:center">db_unique_name</th><th style="text-align:center">IP</th></tr></thead><tbody><tr><td style="text-align:center">wwlc</td><td style="text-align:center">wwlc</td><td style="text-align:center">wwlcdg</td><td style="text-align:center">192.168.66.237</td></tr></tbody></table><h3 id="安装数据库软件-备库"><a href="#安装数据库软件-备库" class="headerlink" title="安装数据库软件(备库)"></a>安装数据库软件(备库)</h3><p><em>安装过程略，可参见：<a href="http://mapele.coding.me/posts/56355/">Linux下安装Oracle11.2.0.1小结</a></em><br><em>PS：只安装软件不创建数据库</em></p><h3 id="确保主库处于归档模式-主库"><a href="#确保主库处于归档模式-主库" class="headerlink" title="确保主库处于归档模式(主库)"></a>确保主库处于归档模式(主库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SQL&gt; archive log list</div><div class="line">Database log mode              Archive Mode</div><div class="line">Automatic archival             Enabled</div><div class="line">Archive destination            +ARCH/wwlc/archfile</div><div class="line">Oldest online log sequence     1128</div><div class="line">Next log sequence to archive   1131</div><div class="line">Current log sequence           1131</div></pre></td></tr></table></figure><p>如果主库处于非归档模式，需要修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">su - oracle</div><div class="line">SQL&gt; alter system set log_archive_dest_1=&apos;location=+ARCH/wwlc/archfile valid_for=(all_logfiles,all_roles) db_unique_name=wwlc&apos; scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; shutdown immediate</div><div class="line">SQL&gt; startup mount</div><div class="line">SQL&gt; alter database archivelog;</div><div class="line">SQL&gt; alter database open;</div></pre></td></tr></table></figure></p><h3 id="确保主库强制Logging-主库"><a href="#确保主库强制Logging-主库" class="headerlink" title="确保主库强制Logging(主库)"></a>确保主库强制Logging(主库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SQL&gt; select force_logging from v$database;</div><div class="line">FORCE_LOGGING</div><div class="line">------------------------------</div><div class="line">YES</div></pre></td></tr></table></figure><p>如果主库处于非归档模式，需要修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter database force logging;</div></pre></td></tr></table></figure></p><h3 id="配置DG所需参数-主库"><a href="#配置DG所需参数-主库" class="headerlink" title="配置DG所需参数(主库)"></a>配置DG所需参数(主库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter system set log_archive_config=&apos;DG_CONFIG=(wwlc,wwlcdg)&apos; scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set log_archive_dest_1=&apos;location=+ARCH/wwlc/archfile valid_for=(all_logfiles,all_roles) db_unique_name=wwlc&apos; scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set log_archive_dest_2=&apos;service=wwlcdg LGWR ASYNC NOAFFIRM valid_for=(online_logfiles,primary_role) db_unique_name=wwlcdg&apos; scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set standby_file_management=auto scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set db_file_name_convert=&apos;/home/s01/app/oracle/oradata/wwlcdg&apos;,&apos;+DATA/wwlc/datafile&apos; scope=spfile sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set log_file_name_convert=&apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog&apos;,&apos;+DATA/wwlc/onlinelog&apos; scope=spfile sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set fal_client=&apos;wwlc&apos; scope=both sid=&apos;*&apos;;</div><div class="line">SQL&gt; alter system set fal_server=&apos;wwlcdg&apos; scope=both sid=&apos;*&apos;;</div></pre></td></tr></table></figure><h3 id="生成pfile并同密码文件一起传输到备库相应目录-主库"><a href="#生成pfile并同密码文件一起传输到备库相应目录-主库" class="headerlink" title="生成pfile并同密码文件一起传输到备库相应目录(主库)"></a>生成pfile并同密码文件一起传输到备库相应目录(主库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SQL&gt; create pfile=&apos;/home/oracle/pfile.ora&apos; from spfile;</div><div class="line">[oracle@rac1 ~]$ scp /home/oracle/temp/pfile root@192.168.66.237:/home/s01/app/oracle/product/11.2.0/db_1/dbs/initwwlc.ora</div><div class="line">[oracle@rac1 ~]$ scp $ORACLE_HOME/dbs/orapwwwlc12 root@192.168.66.237:/home/s01/app/oracle/product/11.2.0/db_1/dbs/orapwwwlc</div></pre></td></tr></table></figure><h3 id="创建目录-备库"><a href="#创建目录-备库" class="headerlink" title="创建目录(备库)"></a>创建目录(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[oracle@backup ~]$ mkdir -pv  /home/s01/app/oracle/oradata/wwlcdg/onlinelog</div><div class="line">[oracle@backup ~]$ mkdir -pv  /home/s01/app/oracle/fast_recovery_area/wwlcdg</div><div class="line">[oracle@backup ~]$ mkdir -pv  /home/s01/app/oracle/admin/wwlc/adump</div><div class="line">[oracle@backup ~]$ mkdir -pv  /home/s01/app/oracle/archive/wwlcdg</div></pre></td></tr></table></figure><h3 id="配置监听-备库"><a href="#配置监听-备库" class="headerlink" title="配置监听(备库)"></a>配置监听(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[oracle@backup ~]$ vim $ORACLE_HOME/network/admin/listener.ora</div><div class="line">添加如下配置：</div><div class="line">SID_LIST_LISTENER =</div><div class="line">  (SID_LIST =</div><div class="line">    (SID_DESC =</div><div class="line">      (GLOBAL_DBNAME = wwlc)</div><div class="line">      (ORACLE_HOME = /home/s01/app/oracle/product/11.2.0/db_1)</div><div class="line">      (SID_NAME = wwlc)</div><div class="line">    )</div><div class="line">  )</div><div class="line">  </div><div class="line">LISTENER =</div><div class="line">  (DESCRIPTION_LIST =</div><div class="line">    (DESCRIPTION =</div><div class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</div><div class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.66.237)(PORT = 1521))</div><div class="line">    )</div><div class="line">  )</div></pre></td></tr></table></figure><h3 id="配置tnsnames-ora-主库、备库"><a href="#配置tnsnames-ora-主库、备库" class="headerlink" title="配置tnsnames.ora(主库、备库)"></a>配置tnsnames.ora(主库、备库)</h3><p><em>rac所有节点 、DG备库添加同样的配置，如下：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[oracle@backup ~]$ vim $ORACLE_HOME/network/admin/tnsnames.ora</div><div class="line">添加如下配置：</div><div class="line">wwlcdg =</div><div class="line">  (DESCRIPTION =</div><div class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.66.237)(PORT = 1521))</div><div class="line">    (CONNECT_DATA =</div><div class="line">      (SERVER = DEDICATED)</div><div class="line">      (SERVICE_NAME = wwlc)</div><div class="line">    )</div><div class="line">  )</div><div class="line"></div><div class="line">wwlc =</div><div class="line">  (DESCRIPTION =</div><div class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.66.66)(PORT = 1521))</div><div class="line">(ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.66.88)(PORT = 1521))</div><div class="line">    (CONNECT_DATA =</div><div class="line">      (SERVER = DEDICATED)</div><div class="line">      (SERVICE_NAME = wwlc)</div><div class="line">    )</div><div class="line">  )</div></pre></td></tr></table></figure></p><h3 id="修改启动参数-备库"><a href="#修改启动参数-备库" class="headerlink" title="修改启动参数(备库)"></a>修改启动参数(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[oracle@backup ~]$ vim /home/s01/app/oracle/product/11.2.0/db_1/dbs/initwwlc.ora</div><div class="line">添加如下配置：</div><div class="line">*.audit_file_dest=&apos;/home/s01/app/oracle/admin/wwlc/adump&apos;</div><div class="line">*.audit_trail=&apos;db&apos;</div><div class="line">*.cluster_database=FALSE</div><div class="line">*.compatible=&apos;11.2.0.4.0&apos;</div><div class="line">*.control_file_record_keep_time=16</div><div class="line">*.control_files=&apos;/home/s01/app/oracle/oradata/wwlcdg/control01.ctl&apos;,&apos;/home/s01/app/oracle/fast_recovery_area/wwlcdg/control02.ctl&apos;</div><div class="line">*.db_block_size=8192</div><div class="line">*.db_domain=&apos;&apos;</div><div class="line">*.db_file_name_convert=&apos;+DATA/wwlc/datafile&apos;,&apos;/home/s01/app/oracle/oradata/wwlcdg&apos;</div><div class="line">*.db_name=&apos;wwlc&apos;</div><div class="line">*.dispatchers=&apos;(PROTOCOL=TCP) (SERVICE=wwlcXDB)&apos;</div><div class="line">*.fal_client=&apos;wwlcdg&apos;</div><div class="line">*.fal_server=&apos;wwlc&apos;</div><div class="line">*.log_archive_config=&apos;DG_CONFIG=(wwlc,wwlcdg)&apos;</div><div class="line">*.log_archive_dest_1=&apos;location=/home/s01/app/oracle/archfile/wwlcdg valid_for=(all_logfiles,all_roles) db_unique_name=wwlcdg&apos;</div><div class="line">*.log_archive_dest_2=&apos;service=wwlcpm LGWR ASYNC NOAFFIRM valid_for=(online_logfiles,primary_role) db_unique_name=wwlc&apos;</div><div class="line">*.log_file_name_convert=&apos;+DATA/wwlc/onlinelog&apos;,&apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog&apos;</div><div class="line">*.memory_max_target=8589934592</div><div class="line">*.memory_target=7589934592</div><div class="line">*.open_cursors=300</div><div class="line">*.pga_aggregate_target=0</div><div class="line">*.processes=150</div><div class="line">*.remote_login_passwordfile=&apos;exclusive&apos;</div><div class="line">*.sga_target=0</div><div class="line">*.standby_file_management=&apos;AUTO&apos;</div><div class="line">*.db_unique_name=&apos;wwlcdg&apos;</div><div class="line">*.service_names=&apos;wwlc&apos;</div><div class="line">*.undo_tablespace=&apos;UNDOTBS1&apos;</div></pre></td></tr></table></figure><h3 id="启动数据库至nomount状态-备库"><a href="#启动数据库至nomount状态-备库" class="headerlink" title="启动数据库至nomount状态(备库)"></a>启动数据库至nomount状态(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SQL&gt; create spfile from pfile;</div><div class="line">SQL&gt; startup nomount</div></pre></td></tr></table></figure><h3 id="复制活动数据库-备库"><a href="#复制活动数据库-备库" class="headerlink" title="复制活动数据库(备库)"></a>复制活动数据库(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[oracle@backup ~]$ rman target sys@wwlc auxiliary sys@wwlcdg</div><div class="line">RMAN&gt; run &#123;</div><div class="line">allocate channel c11 type disk;</div><div class="line">allocate channel c12 type disk;</div><div class="line">allocate channel c13 type disk;</div><div class="line">allocate channel c14 type disk;</div><div class="line">allocate auxiliary channel c21 type disk;</div><div class="line">allocate auxiliary channel c22 type disk;</div><div class="line">allocate auxiliary channel c23 type disk;</div><div class="line">allocate auxiliary channel c24 type disk;</div><div class="line">duplicate target database for standby from active database nofilenamecheck dorecover</div><div class="line">spfile</div><div class="line">parameter_value_convert &apos;wwlc&apos;,&apos;wwlcdg&apos;</div><div class="line">set db_unique_name=&apos;wwlcdg&apos;</div><div class="line">set log_archive_config=&apos;DG_CONFIG=(wwlc,wwlcdg)&apos;</div><div class="line">set log_archive_dest_1=&apos;location=/home/s01/app/oracle/archfile/wwlcdg valid_for=(all_logfiles,all_roles) db_unique_name=wwlcdg&apos;</div><div class="line">set log_archive_dest_2=&apos;service=wwlcpm LGWR ASYNC NOAFFIRM valid_for=(online_logfiles,primary_role) db_unique_name=wwlc&apos;</div><div class="line">set db_file_name_convert=&apos;+DATA/wwlc/datafile&apos;,&apos;/home/s01/app/oracle/oradata/wwlcdg&apos;</div><div class="line">set log_file_name_convert=&apos;+DATA/wwlc/onlinelog&apos;,&apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog&apos;</div><div class="line">set control_files=&apos;/home/s01/app/oracle/oradata/wwlcdg/control01.ctl&apos;</div><div class="line">set fal_client=&apos;wwlcdg&apos;</div><div class="line">set fal_server=&apos;wwlc&apos;</div><div class="line">set standby_file_management=&apos;AUTO&apos;</div><div class="line">set cluster_database=&apos;false&apos;</div><div class="line">set diagnostic_dest=&apos;/home/s01/app/oracle&apos;</div><div class="line">set audit_file_dest=&apos;/home/s01/app/oracle&apos;</div><div class="line">set memory_max_target=&apos;8589934592&apos;</div><div class="line">set memory_target=&apos;7589934592&apos;</div><div class="line">set REMOTE_LISTENER=&apos;&apos;</div><div class="line">;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="添加standby-log-主库、备库"><a href="#添加standby-log-主库、备库" class="headerlink" title="添加standby log(主库、备库)"></a>添加standby log(主库、备库)</h3><h4 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h4><p><em>RAC每个 thread都需要创建且standby redo log 比 redo log 多一组,大小相同</em></p><h4 id="主库-1"><a href="#主库-1" class="headerlink" title="主库"></a>主库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">我的RAC是每个thread 4组日志，每组一个日志文件，所以需要为每个thread创建5组 standby log。</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 1 GROUP 9 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 1 GROUP 10 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 1 GROUP 11 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 1 GROUP 12 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 1 GROUP 13 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 2 GROUP 14 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 2 GROUP 15 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 2 GROUP 16 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 2 GROUP 17 (&apos;+DATA&apos;) size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  thread 2 GROUP 18 (&apos;+DATA&apos;) size 501M;</div></pre></td></tr></table></figure><h4 id="备库-1"><a href="#备库-1" class="headerlink" title="备库"></a>备库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">因为duplicate的时候，两个thread各4个redo log被同步到备库，因此需要创建9组 standby log。</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 9 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo01.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 10 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo02.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 11 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo03.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 12 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo04.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 13 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo05.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 14 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo06.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 15 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo07.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 16 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo08.log&apos; size 501M;</div><div class="line">SQL&gt; ALTER DATABASE ADD STANDBY LOGFILE  GROUP 17 &apos;/home/s01/app/oracle/oradata/wwlcdg/onlinelog/sredo09.log&apos; size 501M;</div></pre></td></tr></table></figure><h3 id="启动物理备库并开启管理恢复进程-MRP-备库"><a href="#启动物理备库并开启管理恢复进程-MRP-备库" class="headerlink" title="启动物理备库并开启管理恢复进程(MRP)(备库)"></a>启动物理备库并开启管理恢复进程(MRP)(备库)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter database open;</div><div class="line">SQL&gt; alter database recover managed standby database using current logfile disconnect from session;</div></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p><em>可通过在主库暂停、开启备用归档目录和切换日志查看数据同步情况。</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter system set log_archive_dest_state_2=defer;</div><div class="line">SQL&gt; alter system set log_archive_dest_state_2=enable;</div><div class="line">SQL&gt; alter system switch logfile;</div><div class="line">SQL&gt; select process,status,thread#,sequence#,block#,blocks from v$managed_standby;</div><div class="line">SQL&gt; select sequence#,applied from v$archived_log order by sequence#;</div><div class="line">SQL&gt; select thread#, low_sequence#, high_sequence# from v$archive_gap;</div></pre></td></tr></table></figure></p><h3 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h3><ul><li>RMAN-06217: not connected to auxiliary database with a net service name<br>  <em>duplicate target database for standby from active database需要使用net service name连接进行账号密码验证，如果使用操作系统验证会出现此错误。</em></li><li>RMAN-04006: error from auxiliary database、ORA-12528: TNS:listener: all appropriate instances are blocking new connections<br>  <em>备用数据库处于nomount状态，无法动态注册到监听，通过net service name连接auxiliary时无法找到服务，可通过在监听器中添加静态注册解决。</em></li><li>ORA-10458: standby database requires recovery<br>  <em>duplicate后打开物理备库可能会报此错误，此时只要打开备库的 日志恢复，让备库apply重做日志即可。</em></li><li>ORA-17628, ORA-19505<br>  <em>db_file_name_convert没有设置，或者设置错误。</em></li><li>RMAN-05517: temporary file <strong>*</strong> conflicts with file used by target dat<br> <em>备库pfile或者duplicate时添加 nofilenamecheck选项，配置正确的db_file_name_convert、log_file_name_convert参数。</em></li><li>MAN-04017: startup error description: ORA-00439: feature not enabled: Real Application Clusters<br> <em>由于主库是 rac ，备库是单实例，所以备库pfile或者duplicate时，需要设置 cluster_database =’false’。</em></li><li>RMAN-05535: WARNING: All redo log files were not defined properly.<br> <em>log_file_name_convert参数必须配置，且为redo日志而不是archive log。</em></li><li>RMAN-05503: at least one auxiliary channel must be allocated to execute this command<br>  <em>手动分配复制通道时(allocate channel) 必须要加上allocate auxiliary channel。</em></li><li>RMAN-06024: no backup or copy of the control file found to restore<br>  <em>如果数据库没有做过全备，则duplicate命令必须带关键词” from active database”。</em></li><li>RMAN-06034: at least 1 channel must be allocated to execute this command<br>  <em>如果duplicate命令中使用关键词” from active database”,则必须为主库分配通道。</em></li><li>ORA-17628: Oracle error 19505 returned by remote Oracle server<br>  <em>相关路径必须存在，比如控制文件路径不存在。</em></li><li>ORA-16047: DGID mismatch between destination setting and standby<br>  <em>log_archive_config参数未配置</em></li><li>ORA-16057: server not in Data  Guard configuration<br>  <em>log_archive_config参数错误，千万注意：dg_config 中必须是db_unique_name,而且主备库都必须配置正确。</em></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/u014257861/article/details/80626257" rel="external nofollow noopener noreferrer" target="_blank">CentOS 6.5 部署 oracle 11G RAC+DG</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;em&gt;最近项目要求给生产环境中的RAC数据库配置DG,过程中遇到不少问题，以此记录，避免同一个问题犯二。&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="RAC" scheme="http://mapele.coding.me/categories/Database/Oracle/RAC/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="RAC" scheme="http://mapele.coding.me/tags/RAC/"/>
    
      <category term="DG" scheme="http://mapele.coding.me/tags/DG/"/>
    
  </entry>
  
  <entry>
    <title>Oracle11gR2 RAC Install On CentOS6.5小结</title>
    <link href="http://mapele.coding.me/posts/43680/"/>
    <id>http://mapele.coding.me/posts/43680/</id>
    <published>2013-07-16T14:34:03.000Z</published>
    <updated>2019-08-08T05:16:37.015Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><em>本小结借鉴于网上各种Oracle RAC安装说明，只记录大致操作，对于安装过程中遇到的问题及具体安装细节未做过多说明，若要参考此文档，需根据自身具体环境而定！</em></p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h4><ul><li><strong>节点服务器*2</strong></li></ul><table><thead><tr><th style="text-align:right">项目</th><th>说明</th></tr></thead><tbody><tr><td style="text-align:right">CPU</td><td>Intel(R) Xeon(R) CPU E5506 @ 2.13GHz *8</td></tr><tr><td style="text-align:right">内存</td><td>64G</td></tr><tr><td style="text-align:right">硬盘</td><td>4*500G 7500转以上</td></tr><tr><td style="text-align:right">HBA</td><td>2块（网络冗余）</td></tr><tr><td style="text-align:right">网卡</td><td>3个千兆网口</td></tr></tbody></table><ul><li><strong>SAN共享存储服务器*1</strong></li></ul><table><thead><tr><th style="text-align:right">项目</th><th>说明</th></tr></thead><tbody><tr><td style="text-align:right">缓存</td><td>32G</td></tr><tr><td style="text-align:right">容量</td><td>12T 可扩展</td></tr><tr><td style="text-align:right">端口</td><td>4个FC</td></tr></tbody></table><h4 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">OS:CentOS 6.5 x86_64</div><div class="line">数据库软件：Oracle 11.2.0.4</div><div class="line">集群套件：Oracle Grid 11.2.0.4</div></pre></td></tr></table></figure><h3 id="架构及规划"><a href="#架构及规划" class="headerlink" title="架构及规划"></a>架构及规划</h3><h4 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h4><h4 id="配置规划"><a href="#配置规划" class="headerlink" title="配置规划"></a>配置规划</h4><ul><li><strong> 节点配置 </strong></li></ul><table><thead><tr><th style="text-align:center">节点名称</th><th style="text-align:center">实例名称</th><th style="text-align:center">数据库名称</th><th style="text-align:center">处理器</th><th style="text-align:center">RAM</th><th style="text-align:center">操作系统</th></tr></thead><tbody><tr><td style="text-align:center">rac1</td><td style="text-align:center">wlc1</td><td style="text-align:center">wwlc</td><td style="text-align:center">8</td><td style="text-align:center">32GB</td><td style="text-align:center">CentOS 6.5 x86_64</td></tr><tr><td style="text-align:center">rac2</td><td style="text-align:center">wlc2</td><td style="text-align:center">wwlc</td><td style="text-align:center">8</td><td style="text-align:center">32GB</td><td style="text-align:center">CentOS 6.5 x86_64</td></tr></tbody></table><ul><li><strong> 网络配置 </strong></li></ul><table><thead><tr><th style="text-align:center">节点名称</th><th style="text-align:center">Public IP</th><th style="text-align:center">Private IP</th><th style="text-align:center">VIP</th><th style="text-align:center">SCAN名称</th><th style="text-align:center">SCAN IP</th></tr></thead><tbody><tr><td style="text-align:center">rac1</td><td style="text-align:center">192.168.199.11</td><td style="text-align:center">192.168.1.11</td><td style="text-align:center">192.168.199.13</td><td style="text-align:center">scan</td><td style="text-align:center">192.168.199.15</td></tr><tr><td style="text-align:center">rac2</td><td style="text-align:center">192.168.199.12</td><td style="text-align:center">192.168.1.12</td><td style="text-align:center">192.168.199.14</td><td style="text-align:center">scan</td><td style="text-align:center">192.168.199.15</td></tr></tbody></table><ul><li><strong> 软件组件 </strong></li></ul><table><thead><tr><th style="text-align:center">软件组件</th><th style="text-align:center">操作系统用户</th><th style="text-align:center">主组</th><th style="text-align:center">辅助组</th><th style="text-align:center">Oracle基目录</th><th style="text-align:center">Oracle主目录</th></tr></thead><tbody><tr><td style="text-align:center">Grid infra</td><td style="text-align:center">grid</td><td style="text-align:center">oinstall</td><td style="text-align:center">asmadmin、asmdba、asmoper</td><td style="text-align:center">/u01/app/grid_base</td><td style="text-align:center">/u01/app/grid_home</td></tr><tr><td style="text-align:center">Oracle RAC</td><td style="text-align:center">oracle</td><td style="text-align:center">oinstall</td><td style="text-align:center">dba、oper、asmdba</td><td style="text-align:center">/u01/app/oracle</td><td style="text-align:center">/u01/app/oracle/p  roduct/11.2.0/db</td></tr></tbody></table><ul><li><strong> 存储组件 </strong></li></ul><table><thead><tr><th style="text-align:center">存储组件</th><th style="text-align:center">类型</th><th style="text-align:center">卷大小</th><th style="text-align:center">ASM卷组名</th><th style="text-align:center">ASM冗余</th><th style="text-align:center">设备名</th></tr></thead><tbody><tr><td style="text-align:center">OCR/VF</td><td style="text-align:center">ASM</td><td style="text-align:center">6G</td><td style="text-align:center">OCR</td><td style="text-align:center">External</td><td style="text-align:center">/dev/asm_diskb</td></tr><tr><td style="text-align:center">数据</td><td style="text-align:center">ASM</td><td style="text-align:center">1.5T</td><td style="text-align:center">DATA</td><td style="text-align:center">External</td><td style="text-align:center">/dev/asm_diskc</td></tr><tr><td style="text-align:center">归档</td><td style="text-align:center">ASM</td><td style="text-align:center">1.5T</td><td style="text-align:center">ARCH</td><td style="text-align:center">External</td><td style="text-align:center">/dev/asm_diskd</td></tr></tbody></table><h3 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h3><h4 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$vi /etc/sysconfig/network</div><div class="line">节点1</div><div class="line">NETWORKING=yes</div><div class="line">HOSTNAME=rac1</div><div class="line">NETWORKING_IPV6=no</div><div class="line">PEERNTP=no</div><div class="line">GATEWAY=192.168.199.1</div><div class="line">NOZEROCONF=yes</div><div class="line">节点2</div><div class="line">NETWORKING=yes</div><div class="line">HOSTNAME=rac2</div><div class="line">NETWORKING_IPV6=no</div><div class="line">PEERNTP=no</div><div class="line">GATEWAY=192.168.199.1</div><div class="line">NOZEROCONF=yes</div><div class="line">NOZEROCONF=ye</div></pre></td></tr></table></figure><h4 id="修改-etc-hosts"><a href="#修改-etc-hosts" class="headerlink" title="修改/etc/hosts"></a>修改/etc/hosts</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">节点1、节点2</div><div class="line">192.168.199.11 rac1</div><div class="line">192.168.199.12 rac2</div><div class="line">192.168.199.13 rac1-vip</div><div class="line">192.168.199.14 rac2-vip</div><div class="line">192.168.1.11 rac1-priv</div><div class="line">192.168.1.12 rac2-priv</div><div class="line">192.168.199.15 scan-ip</div></pre></td></tr></table></figure><h4 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$vi /etc/sysctl.conf</div><div class="line">fs.aio-max-nr = 1048576</div><div class="line">fs.file-max = 6815744</div><div class="line">kernel.shmall =7864320 #内存大小/4096分页大小 </div><div class="line">kernel.shmmax = 52451655680 #内存大小</div><div class="line">kernel.shmmni = 4096</div><div class="line">kernel.sem = 250 32000 100 128</div><div class="line">net.ipv4.ip_local_port_range = 9000 65500</div><div class="line">net.core.rmem_default = 262144</div><div class="line">net.core.rmem_max = 4194304</div><div class="line">net.core.wmem_default = 262144</div><div class="line">net.core.wmem_max = 1048586</div><div class="line">vm.nr_hugepages = sga/pagesize  #开启hugepage，oracle锁定内存防止换出</div><div class="line"></div><div class="line">$sysctl –p</div></pre></td></tr></table></figure><h4 id="配置NTP"><a href="#配置NTP" class="headerlink" title="配置NTP"></a>配置NTP</h4><p><em>oracle rac必须进行时钟同步，如果没有时钟同步，按照下面的方式配置，让oracle自身来解决</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$/sbin/service ntpd stop</div><div class="line">$chkconfig ntpd off</div><div class="line">$mv /etc/ntp.conf /etc/ntp.conf.org</div></pre></td></tr></table></figure></p><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$chkconfig --list iptables</div><div class="line">$chkconfig iptables off</div><div class="line">$chkconfig --list iptables</div><div class="line">$service iptables stop</div><div class="line">$service network restart</div><div class="line">关闭selinux</div><div class="line">$vi /etc/selinux/config</div><div class="line">disable</div></pre></td></tr></table></figure><h4 id="修改用户限制"><a href="#修改用户限制" class="headerlink" title="修改用户限制"></a>修改用户限制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$vi /etc/security/limits.conf</div><div class="line">oracle          soft   nofile         4096</div><div class="line">oracle          hard   nofile         65536</div><div class="line">oracle          soft   nproc          2047</div><div class="line">oracle          hard   nproc          16384</div><div class="line">oracle          soft   stack          10240</div><div class="line">grid            soft   nofile         4096</div><div class="line">grid            hard   nofile         65536</div><div class="line">grid            soft   nproc          2047</div><div class="line">grid            hard   nproc          16384</div><div class="line">grid            soft   stack          10240</div><div class="line">*               soft   memlock        18874368</div><div class="line">*               hard   memlock        18874368</div><div class="line">#以上memlock&lt;ram的大小 单位为k</div></pre></td></tr></table></figure><h4 id="vi-etc-pam-d-login"><a href="#vi-etc-pam-d-login" class="headerlink" title="vi /etc/pam.d/login"></a>vi /etc/pam.d/login</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;session    required     pam_limits.so&quot; &gt;&gt;/etc/pam.d/login</div></pre></td></tr></table></figure><h4 id="安装OS软件包"><a href="#安装OS软件包" class="headerlink" title="安装OS软件包"></a>安装OS软件包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$rpm -q binutils \</div><div class="line">compat-libstdc++-33 \</div><div class="line">elfutils-libelf \</div><div class="line">elfutils-libelf-devel \</div><div class="line">gcc \</div><div class="line">gcc-c++ \</div><div class="line">glibc \</div><div class="line">glibc-common \</div><div class="line">glibc-devel \</div><div class="line">glibc-headers \</div><div class="line">ksh \</div><div class="line">libaio \</div><div class="line">libaio-devel \</div><div class="line">libgcc \</div><div class="line">libstdc++ \</div><div class="line">libstdc++-devel \</div><div class="line">libXp \</div><div class="line">make \</div><div class="line">numactl-devel \</div><div class="line">sysstat \</div><div class="line">unixODBC \</div><div class="line">unixODBC-devel \</div><div class="line">compat-libcap1.x86_64 \</div><div class="line">libcap.x86_64|grep not</div><div class="line">一般要安装下面的软件包</div><div class="line">$yum install -y compat-libstdc++-33</div><div class="line">$yum install -y elfutils-libelf-devel</div><div class="line">$yum install -y gcc-c++</div><div class="line">$yum install -y ksh</div><div class="line">$yum install -y libaio-devel</div><div class="line">$yum install -y libstdc++-devel</div><div class="line">$yum install -y libXp</div><div class="line">$yum install -y numactl-devel</div><div class="line">$yum install -y unixODBC</div><div class="line">$yum install -y unixODBC-devel</div><div class="line">$yum install -y compat-libcap1.x86_64</div></pre></td></tr></table></figure><h4 id="格式化共享磁盘"><a href="#格式化共享磁盘" class="headerlink" title="格式化共享磁盘"></a>格式化共享磁盘</h4><p><em>存储直接划分3个存储组件所需磁盘</em><br>Disk /dev/sdb: 6GB<br>Disk /dev/sdc: 1.5T<br>Disk /dev/sdd: 1.5T</p><h4 id="UDEV绑定磁盘"><a href="#UDEV绑定磁盘" class="headerlink" title="UDEV绑定磁盘"></a>UDEV绑定磁盘</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$for i in b c d ;</div><div class="line">do</div><div class="line">echo &quot;KERNEL==\&quot;sd*\&quot;, BUS==\&quot;scsi\&quot;, PROGRAM==\&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/\$name\&quot;, RESULT==\&quot;`/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sd$i`\&quot;, NAME=\&quot;asm-disk$i\&quot;, OWNER=\&quot;grid\&quot;, GROUP=\&quot;asmadmin\&quot;, MODE=\&quot;0660\&quot;&quot;  &gt;&gt; /etc/udev/rules.d/99-oracle-asmdevices.rules </div><div class="line">done</div></pre></td></tr></table></figure><h4 id="创建grid、oracle用户"><a href="#创建grid、oracle用户" class="headerlink" title="创建grid、oracle用户"></a>创建grid、oracle用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">$/usr/sbin/groupadd -g 501 oinstall</div><div class="line">$/usr/sbin/groupadd -g 502 asmadmin</div><div class="line">$/usr/sbin/groupadd -g 503 dba</div><div class="line">$/usr/sbin/groupadd -g 504 oper</div><div class="line">$/usr/sbin/groupadd -g 505 asmdba</div><div class="line">$/usr/sbin/groupadd -g 506 asmoper</div><div class="line">$/usr/sbin/useradd -u 501 -g oinstall -G asmadmin,asmdba,asmoper,oper,dba grid</div><div class="line">$/usr/sbin/useradd -u 502 -g oinstall -G dba,asmdba,oper oracle</div><div class="line"></div><div class="line">#配置环境变量</div><div class="line">$su- grid</div><div class="line">$Vi .bash_profile</div><div class="line">umask 022</div><div class="line">export ORACLE_BASE=/u01/app/grid_base</div><div class="line">export ORACLE_HOME=/u01/app/grid_home</div><div class="line">export ORACLE_SID=+ASM1  #第二个节点+ASM2</div><div class="line">export PATH=/usr/sbin:$PATH</div><div class="line">export PATH=$ORACLE_HOME/bin:$PATH</div><div class="line"></div><div class="line">$su- oracle</div><div class="line">$Vi .bash_profile</div><div class="line">umask 022</div><div class="line">export ORACLE_BASE=/u01/app/oracle</div><div class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1</div><div class="line">export ORA_GRID_HOME=/u01/app/grid_home</div><div class="line">export ORACLE_UNQNAME=wwlc  </div><div class="line">export ORACLE_SID=wwlc1 #第二个节点wwlc2  </div><div class="line">export PATH=/usr/sbin:$PATH</div><div class="line">export PATH=$ORACLE_HOME/bin:$PATH</div><div class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib:/usr/lib</div><div class="line">export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib</div><div class="line">export NLS_LANG=AMERICAN_AMERICA.AL32UTF8</div><div class="line">export NLS_DATE_FORMAT=&quot;YYYY-MM-DD HH24:MI:SS&quot;</div><div class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</div><div class="line">export LANG=en_US</div></pre></td></tr></table></figure><h4 id="创建安装目录"><a href="#创建安装目录" class="headerlink" title="创建安装目录"></a>创建安装目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$Oraclemkdir -p /u01/app/</div><div class="line">$Oraclemkdir –p /u01/app/grid_base</div><div class="line">$Oraclemkdir –p /u01/app/grid_home</div><div class="line">$Oraclechown -R grid:oinstall /u01/app/grid_base</div><div class="line">$Oraclechown -R grid:oinstall /u01/app/grid_home</div><div class="line">$Oraclechown -R oracle:oinstall /u01/app</div><div class="line">$Oraclechmod -R 775 /u01/app/</div></pre></td></tr></table></figure><h3 id="安装GRID"><a href="#安装GRID" class="headerlink" title="安装GRID"></a>安装GRID</h3><h4 id="准备软件"><a href="#准备软件" class="headerlink" title="准备软件"></a>准备软件</h4><p><em>软件上传至/u01/software</em><br>p13390677_112040_Linux-x86-64_1of7.zip<br>p13390677_112040_Linux-x86-64_2of7.zip<br>p13390677_112040_Linux-x86-64_3of7.zip</p><h4 id="配置对等性"><a href="#配置对等性" class="headerlink" title="配置对等性"></a>配置对等性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">准备秘钥</div><div class="line">$su - grid</div><div class="line">$mkdir ~/.ssh</div><div class="line">$ssh-keygen -t rsa</div><div class="line">$ssh-keygen -t dsa</div><div class="line"></div><div class="line">$su - oracle</div><div class="line">$mkdir ~/.ssh</div><div class="line">$ssh-keygen -t rsa</div><div class="line">$ssh-keygen -t dsa</div><div class="line"></div><div class="line">在节点1执行</div><div class="line">$su - grid</div><div class="line">$cat ~/.ssh/id_rsa.pub&gt;&gt;./.ssh/authorized_keys  --公钥存在authorized_keys文件中,写到本机</div><div class="line">$cat ~/.ssh/id_dsa.pub&gt;&gt;./.ssh/authorized_keys</div><div class="line">$ssh testOracle3Z-PRI cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys  --第二个节点的公钥写到本机</div><div class="line">$ssh testOracle3Z-PRI cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys</div><div class="line">$scp ~/.ssh/authorized_keys testOracle3Z-PRI:~/.ssh/authorized_keys</div><div class="line"></div><div class="line">$su - oracle</div><div class="line">$cat ~/.ssh/id_rsa.pub&gt;&gt;./.ssh/authorized_keys  --公钥存在authorized_keys文件中,写到本机</div><div class="line">$cat ~/.ssh/id_dsa.pub&gt;&gt;./.ssh/authorized_keys</div><div class="line">$ssh testOracle3Z-PRI cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys  --第二个节点的公钥写到本机</div><div class="line">$ssh testOracle3Z-PRI cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys</div><div class="line">$scp ~/.ssh/authorized_keys testOracle3Z-PRI:~/.ssh/authorized_keys</div><div class="line"></div><div class="line">验证</div><div class="line">$ssh rac1 date   (public网卡)</div><div class="line">$ssh rac2 date</div><div class="line">$ssh rac1-priv date  (private网卡)</div><div class="line">$ssh rac2-priv date</div></pre></td></tr></table></figure><h4 id="安装预检查"><a href="#安装预检查" class="headerlink" title="安装预检查"></a>安装预检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$su - grid</div><div class="line">$cd grid的软件目录</div><div class="line">$./runcluvfy.sh stage -pre crsinst -n rac1,rac2 -verbose</div></pre></td></tr></table></figure><h4 id="准备响应文件"><a href="#准备响应文件" class="headerlink" title="准备响应文件"></a>准备响应文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$vi crsinst </div><div class="line">ORACLE_HOSTNAME=rac1</div><div class="line">INVENTORY_LOCATION=/u01/app/oraInventory</div><div class="line">oracle.install.option=CRS_CONFIG</div><div class="line">ORACLE_BASE=/u01/app/grid_base</div><div class="line">ORACLE_HOME=/u01/app/grid_home</div><div class="line">oracle.install.asm.OSDBA=asmdba</div><div class="line">oracle.install.asm.OSOPER=asmoper</div><div class="line">oracle.install.asm.OSASM=asmadmin</div><div class="line">oracle.install.crs.config.gpnp.scanPort=1521</div><div class="line">oracle.install.crs.config.clusterName=rac-cluster</div><div class="line">oracle.install.crs.config.clusterNodes=rac1:rac1-vip,rac2:rac2-vip</div><div class="line">oracle.install.crs.config.privateInterconnects=edge1:192.168.1.0:2,edge0:192.168.199.0:1   //1代表public，2代表private，3代表在群集中不使用该网卡</div><div class="line">oracle.install.crs.config.storageOption=ASM_STORAGE</div><div class="line">oracle.install.asm.SYSASMPassword=grid123456</div><div class="line">oracle.install.asm.diskGroup.name=OCR</div><div class="line">oracle.install.asm.diskGroup.redundancy=External</div><div class="line">oracle.install.asm.diskGroup.AUSize=1</div><div class="line">oracle.install.asm.diskGroup.disks=/dev/asm-diskb</div><div class="line">oracle.install.asm.diskGroup.diskDiscoveryString=/dev/asm-disk*</div><div class="line">oracle.install.asm.monitorPassword=grid</div></pre></td></tr></table></figure><h4 id="安装grid"><a href="#安装grid" class="headerlink" title="安装grid"></a>安装grid</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$./runInstaller -silent -responseFile /u01/software/grid/response/crs_install_test.rsp -ignoreSysPrereqs -ignorePrereq</div><div class="line">等待一段时间后，会提示在两个节点分别用root用户执行：</div><div class="line">#/u01/grid/oraInventory/orainstRoot.sh</div><div class="line">#/u01/crs/11.2.0/root.sh</div></pre></td></tr></table></figure><h4 id="创建磁盘组"><a href="#创建磁盘组" class="headerlink" title="创建磁盘组"></a>创建磁盘组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#su – grid</div><div class="line">$asmca</div><div class="line">或者使用命令行</div><div class="line">$ asmca -silent -createDiskGroup -sysAsmPassword grid12345 -diskString &apos;/dev/asm-disk*&apos; -diskGroupName DATA -diskList &apos;/dev/asm-diskc&apos; -redundancy External-compatible.asm 11.2 -compatible.rdbms 11.2 </div><div class="line">$ asmca -silent -createDiskGroup -sysAsmPassword grid12345 -diskString &apos;/dev/asm-disk*&apos; -diskGroupName ARCH -diskList &apos;/dev/asm-diskd&apos; -redundancy External-compatible.asm 11.2 -compatible.rdbms 11.2</div></pre></td></tr></table></figure><h3 id="安装Database-图形安装可省略"><a href="#安装Database-图形安装可省略" class="headerlink" title="安装Database(图形安装可省略)"></a>安装Database(图形安装可省略)</h3><h4 id="注册产品列表"><a href="#注册产品列表" class="headerlink" title="注册产品列表"></a>注册产品列表</h4><p>/u01/app/oraInventory/ContentsXMLinventory.xml<br>/u01/app/oraInventory/ContentsXML</p><h4 id="准备响应文件-1"><a href="#准备响应文件-1" class="headerlink" title="准备响应文件"></a>准备响应文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ vi /u01/soft/oracle/database/response/db_install_test.rsp</div><div class="line">oracle.install.option=INSTALL_DB_SWONLY</div><div class="line">ORACLE_HOSTNAME=rac1</div><div class="line">UNIX_GROUP_NAME=oinstall</div><div class="line">INVENTORY_LOCATION=/u01/app/oraInventory</div><div class="line">SELECTED_LANGUAGES=en</div><div class="line">ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1</div><div class="line">ORACLE_BASE=/u01/app/oracle</div><div class="line">oracle.install.db.InstallEdition=EE</div><div class="line">oracle.install.db.isCustomInstall=false</div><div class="line">oracle.install.db.optionalComponents=oracle.rdbms.partitioning:11.2.0.4.0,oracle.oraolap:11.2.0.4.0,oracle.rdbms.dm:11.2.0.4.0,oracle.rdbms.dv:11.2.0.4.0,oracle.rdbms.lbac:11.2.0.4.0,oracle.r</div><div class="line">dbms.rat:11.2.0.4.0oracle.install.db.DBA_GROUP=dba</div><div class="line">oracle.install.db.OPER_GROUP=oinstall</div><div class="line">oracle.install.db.CLUSTER_NODES=rac1,rac2</div><div class="line">DECLINE_SECURITY_UPDATES=true</div></pre></td></tr></table></figure><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$./runInstaller -silent -ignoreSysPrereqs -ignorePrereq -responseFile /u01/software/database/response/db_install_test.rsp</div><div class="line">#/u01/grid/oraInventory/orainstRoot.sh</div><div class="line">#/u01/oracle/11.2.0/root.sh</div></pre></td></tr></table></figure><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p><em>创建数据库可以使用dbca交互界面，也可以使用静默创建方式</em></p><h4 id="准备响应文件-2"><a href="#准备响应文件-2" class="headerlink" title="准备响应文件"></a>准备响应文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$vi /u01/soft/oracle/database/response/dbca_orcl.rsp</div><div class="line">GDBNAME = &quot;wwlc&quot;</div><div class="line">SID = &quot;wwlc&quot;</div><div class="line">NODELIST=rac1,rac2</div><div class="line">SYSPASSWORD = &quot;wwlc123456&quot;</div><div class="line">SYSTEMPASSWORD = &quot;wwlc123456&quot;</div><div class="line">STORAGETYPE=ASM</div><div class="line">DISKGROUPNAME=DATA</div><div class="line">RECOVERYGROUPNAME=DATA</div><div class="line">CHARACTERSET = &quot;AL32UTF8&quot;</div></pre></td></tr></table></figure><h4 id="创建数据库-1"><a href="#创建数据库-1" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dbca -silent -responseFile /u01/software/database/response/dbca_orcl.rsp</div></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.debugrun.com/a/bePB8gY.html" rel="external nofollow noopener noreferrer" target="_blank">阿里云上Oracle 11g RAC安装配置手册</a><br><a href="https://yq.aliyun.com/articles/88303" rel="external nofollow noopener noreferrer" target="_blank">手把手教你在ECS上部署Oracle RAC-博客-云栖社区-阿里云</a><br><a href="https://yq.aliyun.com/articles/62615" rel="external nofollow noopener noreferrer" target="_blank">如何在ECS上搭建Oracle？Oracle云上云下6种架构全解析-博客-云栖社区-阿里云</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;em&gt;本小结借鉴于网上各种Oracle RAC安装说明，只记录大致操作，对于安装过程中遇到的问题及具体安装细节未做过多说明，若要参考此文档
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="RAC" scheme="http://mapele.coding.me/categories/Database/Oracle/RAC/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="RAC" scheme="http://mapele.coding.me/tags/RAC/"/>
    
      <category term="ASM" scheme="http://mapele.coding.me/tags/ASM/"/>
    
  </entry>
  
  <entry>
    <title>Oracle TTS From windows to linux +ASM</title>
    <link href="http://mapele.coding.me/posts/5864/"/>
    <id>http://mapele.coding.me/posts/5864/</id>
    <published>2013-06-23T06:27:21.000Z</published>
    <updated>2019-08-08T05:16:22.520Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><em>一直想试试Oracle的TTS迁移方案，刚好公司最近有项目需要进行已购平台的数据库迁移，正好派上用场。以下为大致过程，具体细节不做描述，只概括主要操作。</em></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><h4 id="源端"><a href="#源端" class="headerlink" title="源端"></a>源端</h4><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>操作系统</td><td>Microsoft Windows 7 64位</td></tr><tr><td>endianness格式</td><td>little</td></tr><tr><td>数据库版本</td><td>11.2.0.1</td></tr></tbody></table><h4 id="目标端"><a href="#目标端" class="headerlink" title="目标端"></a>目标端</h4><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS 6.3 64位</td></tr><tr><td>endianness 格式</td><td>little</td></tr><tr><td>数据库版本</td><td>11.2.0.4</td></tr></tbody></table><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="查看字符集"><a href="#查看字符集" class="headerlink" title="查看字符集"></a>查看字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SQL&gt;SELECT *  </div><div class="line">      FROM NLS_DATABASE_PARAMETERS T</div><div class="line">     WHERE T.PARAMETER LIKE &apos;%CHARACTERSET&apos;;</div></pre></td></tr></table></figure><p><em>如果字符集不一致，需要修改字符集：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SHUTDOWN IMMEDIATE</div><div class="line">SQL&gt; STARTUP MOUNT</div><div class="line">SQL&gt; ALTER SYSTEM ENABLE RESTRICTED SESSION;</div><div class="line">SQL&gt; ALTER SYSTEM SET JOB_QUEUE_PROCESSES=0;</div><div class="line">SQL&gt; ALTER SYSTEM SET AQ_TM_PROCESSES=0;</div><div class="line">SQL&gt; ALTER DATABASE OPEN</div><div class="line">SQL&gt; ALTER DATABASE NATIONAL CHARACTER SETINTERNAL_USE UTF8;</div><div class="line">SQL&gt; SHUTDOWN IMMEDIATE</div><div class="line">SQL&gt; STARTUP</div></pre></td></tr></table></figure></p><h4 id="检查db-time-zone"><a href="#检查db-time-zone" class="headerlink" title="检查db time zone"></a>检查db time zone</h4><p><em>源端和目标端的db time zone 是否一致：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT version FROM v$timezone_file;</div></pre></td></tr></table></figure></p><p><em>Oracle 9i 的time zone 文件version是1，10g 是2，到了11gR2，time zone files 可以从1到14.</em><br><em>默认情况下：</em><br><em>11.2.0.1 的time zone 是11。</em><br><em>11.2.0.2的time zone 是14。</em><br><em>11.2.0.3的time zone 是14。</em><br><em>如果time zone 不同，那么在import 时会报ORA-39322 的错误,不过该问题已在11.2.0.4解决 。</em></p><h4 id="查看要迁移表空间文件"><a href="#查看要迁移表空间文件" class="headerlink" title="查看要迁移表空间文件"></a>查看要迁移表空间文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT FILE_NAME</div><div class="line">       FROM DBA_DATA_FILES T</div><div class="line">       WHERE T.TABLESPACE_NAME = &apos;TablespaceName&apos;</div></pre></td></tr></table></figure><h4 id="表空间检查"><a href="#表空间检查" class="headerlink" title="表空间检查"></a>表空间检查</h4><p><em>TTS 仅支持对象都在要传输的表空间里，表空间里的对象不能与其他表空间有逻辑上或者物理上的依赖关系。</em><br><em>可以使用TRANSPORT_SET_CHECK过程来检查表空间是否自包含。调用该过程需要EXECUTE_CATALOG_ROLE角色。</em><br><em>检查表空间自包含：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; EXECUTE DBMS_TTS.TRANSPORT_SET_CHECK(&apos;TablespaceName&apos;, TRUE);</div></pre></td></tr></table></figure></p><p><em>dbms_tts 检查自包含的结果可以通过TRANSPORT_SET_VIOLATIONS视图查看，如果为空，就是自包含，如果不是自包含的，会列出这些对象。</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT * FROM TRANSPORT_SET_VIOLATIONS;</div></pre></td></tr></table></figure></p><h4 id="设置表空间为只读"><a href="#设置表空间为只读" class="headerlink" title="设置表空间为只读"></a>设置表空间为只读</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; ALTER TABLESPACE TablespaceName READ ONLY;</div></pre></td></tr></table></figure><h4 id="创建datapump目录"><a href="#创建datapump目录" class="headerlink" title="创建datapump目录"></a>创建datapump目录</h4><ul><li><p><strong>源端：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt;create directory backup as &apos;F:\datapump&apos;;</div></pre></td></tr></table></figure></li><li><p><strong>目标端：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt;create directory backup as &apos;/home/oracle/datapump&apos;;</div></pre></td></tr></table></figure></li></ul><h4 id="源端导出表空间元数据"><a href="#源端导出表空间元数据" class="headerlink" title="源端导出表空间元数据"></a>源端导出表空间元数据</h4><ul><li><p><strong>使用expdp：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$expdp \&apos;/ as sysdba\&apos; dumpfile=expdat.dmp directory=backup transport_tablespaces=TablespaceName transport_full_check=y </div><div class="line">logfile=expdat.log</div><div class="line">Username: /as sysdba</div></pre></td></tr></table></figure></li><li><p><strong>使用exp：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">exp userid=\&apos;/ as sysdba\&apos; transport_tablespace=y </div><div class="line">tablespaces=TablespaceName file=expdat.dmp log=expdat.log </div><div class="line">statistics=none</div></pre></td></tr></table></figure></li></ul><h4 id="上传表空间原始数据至目标端datapump目录"><a href="#上传表空间原始数据至目标端datapump目录" class="headerlink" title="上传表空间原始数据至目标端datapump目录"></a>上传表空间原始数据至目标端datapump目录</h4><h4 id="上传表空间数据文件至目标端数据库数据文件存储目录"><a href="#上传表空间数据文件至目标端数据库数据文件存储目录" class="headerlink" title="上传表空间数据文件至目标端数据库数据文件存储目录"></a>上传表空间数据文件至目标端数据库数据文件存储目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ASMCMD&gt; cp /home/grid/temp/file.DBF +data/datafile/file.DBF</div></pre></td></tr></table></figure><h4 id="查看平台及字节序"><a href="#查看平台及字节序" class="headerlink" title="查看平台及字节序"></a>查看平台及字节序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">SQL&gt; column platform_name format a40</div><div class="line">SQL&gt; column endian_format format a40</div><div class="line">SQL&gt; SELECT A.PLATFORM_NAME</div><div class="line">           ,A.ENDIAN_FORMAT</div><div class="line">       FROM V$TRANSPORTABLE_PLATFORM A</div><div class="line">           ,V$DATABASE               B</div><div class="line">      WHERE A.PLATFORM_NAME = B.PLATFORM_NAME;</div><div class="line">目标端：</div><div class="line">PLATFORM_NAME                        ENDIAN_FORMAT</div><div class="line">------------------------------------ --------------</div><div class="line">Linux x86 64-bit                     Little</div><div class="line">源端：</div><div class="line">PLATFORM_NAME                        ENDIAN_FORMAT</div><div class="line">------------------------------------ --------------</div><div class="line">Microsoft Windows IA (32-bit)        Little</div></pre></td></tr></table></figure><h4 id="endianness转换"><a href="#endianness转换" class="headerlink" title="endianness转换"></a>endianness转换</h4><p><em>如果TTS在不同的平台上，并且ENDIAN_FORMAT也不同，那么就需要先使用RMAN 进行endianness的转换，这个过程可以在Source 端处理，也可以在Target 处理。</em></p><ul><li><strong>源端处理：</strong>    </li></ul><p><em>源端只能使用 covert tablespace。</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; CONVERT TABLESPACE TablespaceName1,TablespaceName2 TO PLATFORM &apos;PLATFORM_NAME&apos; DB_FILE_NAME_CONVERT=&apos;/oradata/datafile/&apos;,&apos;/tmp/&apos; FORMAT &apos;/tmp/%U&apos;;</div></pre></td></tr></table></figure></p><ul><li><strong>目标端处理：</strong></li></ul><p><em>源端只能使用 covert datafile。先将datafile从source 端拷贝到Target ，然后在Target 端进行转换。</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RMAN&gt; CONVERT DATAFILE &apos;/tmp/file.dbf&apos;</div><div class="line">      TO PLATFORM=&quot;Linux IA (32-bit)&quot;FROM PLATFORM=&quot;HP TRu64 UNIX&quot;</div><div class="line">      DB_FILE_NAME_CONVERT=&quot;/tmp/&quot;,&quot;+data/datafile/&quot;;</div></pre></td></tr></table></figure></p><h4 id="查询源端使用了相应表空间的用户"><a href="#查询源端使用了相应表空间的用户" class="headerlink" title="查询源端使用了相应表空间的用户"></a>查询源端使用了相应表空间的用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SQL&gt; SELECT DISTINCT OWNER</div><div class="line">       FROM DBA_SEGMENTS T</div><div class="line">      WHERE T.TABLESPACE_NAME = &apos;TablespaceName&apos;;</div></pre></td></tr></table></figure><h4 id="目标端创建相应用户"><a href="#目标端创建相应用户" class="headerlink" title="目标端创建相应用户"></a>目标端创建相应用户</h4><p><em>将上一步列出的用户在目标端创建</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; create user username identified by &quot;pwd&quot;;</div></pre></td></tr></table></figure></p><h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><ul><li><strong>使用impdp：</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ impdp \&apos;/ as sysdba\&apos; directory=backup dumpfile=&quot;expdat.dmp&quot; transport_datafiles=+data/datafile/file.DBF logfile=expdat.log</div></pre></td></tr></table></figure></li></ul><p><em>如果目标端与源端schema不对应，使用remap_chema参数对应，如remap_schema=schema1:user1 remap_schema=schema2:user2</em></p><p><em>如果表空间在Target上已经存在，那么可以使用remap_tablespace 参数来进行表空间的转换</em></p><ul><li><strong>使用imp</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ imp userid=\&apos;/ as sysdba\&apos; TRANSPORT_TABLESPACE=Y datafiles=/database/db101b2/V101B2/datafile/reposit01.dbf file=tts.dmp log=imp_tts.log</div></pre></td></tr></table></figure></li></ul><h4 id="将表空间设置为读写模式"><a href="#将表空间设置为读写模式" class="headerlink" title="将表空间设置为读写模式"></a>将表空间设置为读写模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter tablespace TablespaceName read write;</div></pre></td></tr></table></figure><h4 id="修改用户默认表空间"><a href="#修改用户默认表空间" class="headerlink" title="修改用户默认表空间"></a>修改用户默认表空间</h4><p><em>如果涉及用户默认表空间发送更改，需要修改用户的默认表空间</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SQL&gt; alter user username default tablespace TablespaceName;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;em&gt;一直想试试Oracle的TTS迁移方案，刚好公司最近有项目需要进行已购平台的数据库迁移，正好派上用场。以下为大致过程，具体细节不做描
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="数据迁移" scheme="http://mapele.coding.me/categories/Database/Oracle/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="tts" scheme="http://mapele.coding.me/tags/tts/"/>
    
  </entry>
  
  <entry>
    <title>Linux下安装Oracle11.2.0.1小结</title>
    <link href="http://mapele.coding.me/posts/56355/"/>
    <id>http://mapele.coding.me/posts/56355/</id>
    <published>2012-02-08T15:45:43.000Z</published>
    <updated>2017-09-10T14:43:36.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><em>网上关于Linxu下安装Oralce的资料数不尽数，但是总找不到适合自己，用起来拿心应手的；以前数据库安装无数次，也没有总结、特参照网上其它大牛资料及结合自己应用经验小结，以示牢记！ </em></p><h3 id="安装注意事项"><a href="#安装注意事项" class="headerlink" title="安装注意事项"></a>安装注意事项</h3><ol><li>尽量选择英语环境，中文环境下有时候会出现乱码的情况。</li><li>磁盘分区建议采用系统默认方式LVM管理，比较方便后续扩展。如果需要设置指定的分区/s01，就稍微修改下分50G给/，其他分给/s01</li><li>安装时设置好时区，取消UTC时钟。</li><li>设置主机名和网络IP地址.</li><li>选择默认安装模式时选择第一个Desktop即可。oracle安装的包问题后面准备是依依指定，新版本没法偷懒，没有选所有rpm包的地方。</li><li>系统安装后进入桌面环境，默认不建议在桌面系统登录root用户。</li></ol><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><em>以下操作未明确说明都在在root用户下操作</em></p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>   OS:           VBox + Oracle Linux Server release 6.5<br>   DB Version: Oracle-11.2.0.1</p><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><h4 id="配置yum"><a href="#配置yum" class="headerlink" title="配置yum"></a>配置yum</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/yum.repos.d</div><div class="line">[base]</div><div class="line">name=Oracle linux 6.5 base</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line">baseurl=file:///media/cdrom </div><div class="line">$ mount /dev/cdrom /media/cdrom --映射光盘到对应的目录下：</div></pre></td></tr></table></figure><h4 id="利用oracle-rdbms-server-11gR2-preinstall实现快速部署"><a href="#利用oracle-rdbms-server-11gR2-preinstall实现快速部署" class="headerlink" title="利用oracle-rdbms-server-11gR2-preinstall实现快速部署"></a>利用oracle-rdbms-server-11gR2-preinstall实现快速部署</h4><ul><li>自动安装oracle所需的RPM包</li><li>自动创建oracle用户和group组</li><li>自动配置/etc/sysctl.conf内核参数</li><li>自动配置/etc/security/limits.conf参数</li><li>关闭NUMA=OFF （关闭非一致内存访问）</li></ul><p><em>可跳过”安装依赖包”-“设置环境变量”前的手工配置步骤</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$yum install oracle-rdbms-server-11gR2-preinstall</div></pre></td></tr></table></figure><h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">*The following or later version of packages for Asianux 3, Oracle Linux 5, and Red </div><div class="line">Hat Enterprise Linux 5 must be installed:*</div><div class="line"></div><div class="line">binutils-2.17.50.0.6</div><div class="line">compat-libstdc++-33-3.2.3</div><div class="line">compat-libstdc++-33-3.2.3 (32 bit)</div><div class="line">elfutils-libelf-0.125</div><div class="line">elfutils-libelf-devel-0.125</div><div class="line">gcc-4.1.2</div><div class="line">gcc-c++-4.1.2</div><div class="line">glibc-2.5-24</div><div class="line">glibc-2.5-24 (32 bit)</div><div class="line">glibc-common-2.5</div><div class="line">glibc-devel-2.5</div><div class="line">glibc-devel-2.5 (32 bit)</div><div class="line">glibc-headers-2.5</div><div class="line">ksh-20060214</div><div class="line">libaio-0.3.106</div><div class="line">libaio-0.3.106 (32 bit)</div><div class="line">libaio-devel-0.3.106</div><div class="line">libaio-devel-0.3.106 (32 bit)</div><div class="line">libgcc-4.1.2</div><div class="line">libgcc-4.1.2 (32 bit)</div><div class="line">libstdc++-4.1.2</div><div class="line">libstdc++-4.1.2 (32 bit)</div><div class="line">libstdc++-devel 4.1.2</div><div class="line">make-3.81</div><div class="line">sysstat-7.0.2</div><div class="line"></div><div class="line">*The following or later version of packages for Oracle Linux 6, and Red Hat </div><div class="line">Enterprise Linux 6 must be installed:*</div><div class="line"></div><div class="line">binutils-2.20.51.0.2-5.11.el6</div><div class="line">compat-libcap1-1.10-1 </div><div class="line">compat-libstdc++-33-3.2.3-69.el6</div><div class="line">compat-libstdc++-33-3.2.3-69.el6.i686 </div><div class="line">gcc-4.4.4-13.el6</div><div class="line">gcc-c++-4.4.4-13.el6</div><div class="line">glibc-2.12-1.7.el6.i686</div><div class="line">glibc-2.12-1.7.el6</div><div class="line">glibc-devel-2.12-1.7.el6</div><div class="line">glibc-devel-2.12-1.7.el6.i686 </div><div class="line">ksh </div><div class="line">libgcc-4.4.4-13.el6.i686</div><div class="line">libgcc-4.4.4-13.el6</div><div class="line">libstdc++-4.4.4-13.el6</div><div class="line">libstdc++-4.4.4-13.el6.i686 </div><div class="line">libstdc++-devel-4.4.4-13.el6</div><div class="line">libstdc++-devel-4.4.4-13.el6.i686 </div><div class="line">libaio-0.3.107-10.el6</div><div class="line">libaio-0.3.107-10.el6.i686 </div><div class="line">libaio-devel-0.3.107-10.el6</div><div class="line">libaio-devel-0.3.107-10.el6.i686 </div><div class="line">make-3.81-19.el6 </div><div class="line">sysstat-9.0.4-11.el6</div><div class="line"></div><div class="line">$ yum install binutils compat-libcap1 compat-libstdc++-33 compat-libstdc++-33.i686 gcc gcc-c++ glibc glibc.i686 glibc-devel glibc-devel.i686 ksh libgcc libgcc.i686 libstdc++ libstdc++.i686 libstdc++-devel libstdc++-devel.i686 libaio libaio.i686 libaio-devel libaio-devel.i686 make sysstat unixODBC unixODBC.i686 unixODBC-devel unixODBC-devel.i686</div></pre></td></tr></table></figure><h4 id="建立Oracle用户和组"><a href="#建立Oracle用户和组" class="headerlink" title="建立Oracle用户和组"></a>建立Oracle用户和组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ groupadd oinstall</div><div class="line">$ groupadd dba</div><div class="line">$ useradd -g oinstall -G dba oracle</div><div class="line">$ passwd oracle</div></pre></td></tr></table></figure><h4 id="建立目录和属主"><a href="#建立目录和属主" class="headerlink" title="建立目录和属主"></a>建立目录和属主</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /s01/oracle/11g</div><div class="line">$ chown -R oracle:oinstall /s01</div><div class="line">$ chmod -R 755 /s01</div></pre></td></tr></table></figure><h4 id="配置系统内核参数"><a href="#配置系统内核参数" class="headerlink" title="配置系统内核参数"></a>配置系统内核参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ vi /etc/sysctl.conf</div><div class="line">fs.suid_dumpable = 1</div><div class="line">fs.aio-max-nr = 1048576</div><div class="line">fs.file-max = 6815744</div><div class="line">kernel.shmall = 2097152</div><div class="line">kernel.shmmax = 536870912</div><div class="line">kernel.shmmni = 4096</div><div class="line">kernel.sem = 250 32000 100 128</div><div class="line">net.ipv4.ip_local_port_range = 9000 65500</div><div class="line">net.core.rmem_default = 262144</div><div class="line">net.core.rmem_max = 4194304</div><div class="line">net.core.wmem_default = 262144</div><div class="line">net.core.wmem_max = 1048586</div><div class="line">$ sysctl -p --立即刷行配置</div></pre></td></tr></table></figure><h4 id="设置-etc-security-limits-conf"><a href="#设置-etc-security-limits-conf" class="headerlink" title="设置/etc/security/limits.conf"></a>设置/etc/security/limits.conf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ vi /etc/security/limits.conf</div><div class="line">#For Oracle</div><div class="line">oracle          soft          nproc          2047</div><div class="line">oracle          hard          nproc          16384</div><div class="line">oracle          soft          nofile         1024</div><div class="line">oracle          hard          nofile         65536</div></pre></td></tr></table></figure><h4 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ su - oracle</div><div class="line">$ cd ~</div><div class="line">$ vim .bash_profile</div><div class="line">ORACLE_HOME=/s01/oracle/app/oracle/product/11.2.0/dbhome_1</div><div class="line">ORACLE_BASE=/s01/oracle</div><div class="line">ORACLE_SID=XWY</div><div class="line">PATH=$ORACLE_HOME/OPatch:$ORACLE_HOME/bin:/bin:/sbin:/usr/bin:/usr/sbin:$HOME:PATH</div><div class="line">export PATH ORACLE_HOME ORACLE_BASE ORACLE_SID</div><div class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$ORACLE_HOME/lib32</div><div class="line">export NLS_LANG=american_america.AL32UTF8</div><div class="line">export DISPLAY=IP:0.0</div></pre></td></tr></table></figure><h4 id="etc-hosts文件中加入主机名的解析，防止监听配置有问题。"><a href="#etc-hosts文件中加入主机名的解析，防止监听配置有问题。" class="headerlink" title="/etc/hosts文件中加入主机名的解析，防止监听配置有问题。"></a>/etc/hosts文件中加入主机名的解析，防止监听配置有问题。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/hosts</div><div class="line">127.0.0.1              OEL6.5 localhost.localdomain localhost</div></pre></td></tr></table></figure><h4 id="关闭SELINUX和防火墙"><a href="#关闭SELINUX和防火墙" class="headerlink" title="关闭SELINUX和防火墙"></a>关闭SELINUX和防火墙</h4><p><em>可以在界面上操作防火墙，system–&gt;Administration–&gt;firewall–&gt;Disable  apply</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ chkconfig iptables off</div><div class="line">$ service iptables stop</div><div class="line">$ chkconfig ip6tables off</div><div class="line">$ service ip6tables stop</div></pre></td></tr></table></figure></p><h4 id="vi-etc-selinux-config"><a href="#vi-etc-selinux-config" class="headerlink" title="vi /etc/selinux/config"></a>vi /etc/selinux/config</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ vim /etc/selinux/config</div><div class="line">将SELINUX=enforced 修改为SELINUX=disabled后重启</div></pre></td></tr></table></figure><h4 id="本机安装或设置Xmanager远程图形界面安装"><a href="#本机安装或设置Xmanager远程图形界面安装" class="headerlink" title="本机安装或设置Xmanager远程图形界面安装"></a>本机安装或设置Xmanager远程图形界面安装</h4><p><em>本机安装请确认xhost可以正常显示即可。而客户端配置需启动Xmanager- Passive模式</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ export DISPLAY=IP:0.0</div><div class="line">$ xhost</div><div class="line">access control disabled, clients can connect from any host</div><div class="line">INET:172.30.16.254</div><div class="line">INET:192.168.1.66</div><div class="line">INET:192.168.2.66</div></pre></td></tr></table></figure></p><h3 id="数据库安装及升级"><a href="#数据库安装及升级" class="headerlink" title="数据库安装及升级"></a>数据库安装及升级</h3><h4 id="安装Oracle软件"><a href="#安装Oracle软件" class="headerlink" title="安装Oracle软件"></a>安装Oracle软件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cd /home/oracle/database</div><div class="line">$ ./runInstaller</div><div class="line">$ sh /s01/oracle/oraInventory/orainstRoot.sh</div><div class="line">$ sh /s01/oracle/10g/root.sh</div></pre></td></tr></table></figure><h4 id="配置监听"><a href="#配置监听" class="headerlink" title="配置监听"></a>配置监听</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ su - oracle</div><div class="line">$ netca</div></pre></td></tr></table></figure><h4 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h4><h5 id="图形化安装"><a href="#图形化安装" class="headerlink" title="图形化安装"></a>图形化安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ su - oracle</div><div class="line">$ dbca</div></pre></td></tr></table></figure><h5 id="手动创建"><a href="#手动创建" class="headerlink" title="手动创建"></a>手动创建</h5><ul><li><p><strong>创建参数文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ vi $ORACLE_HOME/dbs/initxwy.ora</div><div class="line">db_name=&apos;xwy&apos;</div><div class="line">memory_target=800M</div><div class="line">processes = 150</div><div class="line">audit_file_dest=&apos;/s01/admin/xwy/adump&apos;</div><div class="line">audit_trail =&apos;db&apos;</div><div class="line">db_block_size=8192</div><div class="line">db_domain=&apos;oracle.com&apos;db_recovery_file_dest=&apos;/s01/flash_recovery_area&apos;</div><div class="line">db_recovery_file_dest_size=10G</div><div class="line">diagnostic_dest=&apos;/s01&apos;</div><div class="line">dispatchers=&apos;(PROTOCOL=TCP)(SERVICE=xwy)&apos;</div><div class="line">open_cursors=300</div><div class="line">remote_login_passwordfile=&apos;EXCLUSIVE&apos;</div><div class="line">undo_tablespace=&apos;UNDOTBS1&apos;</div><div class="line">-- You may want to ensure that control files are created on separate physicaldevices</div><div class="line">control_files = (/s01/oradata/xwy/control1.ctl,/s01/oradata/xwy/control2.ctl)</div><div class="line">compatible =&apos;11.2.0&apos;</div></pre></td></tr></table></figure></li><li><p><strong>建立所需目录</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p $ORACLE_BASE/admin/xwy/adump</div><div class="line">$ mkdir -p $ORACLE_BASE/flash_recovery_area</div><div class="line">$ mkdir -p $ORACLE_BASE/oradata/xwy</div></pre></td></tr></table></figure></li><li><p><strong>创建数据库脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ vi create_db.sql</div><div class="line">CREATE DATABASE xwy</div><div class="line">USER SYS IDENTIFIED BY xwy</div><div class="line">USER SYSTEM IDENTIFIED BY xwy</div><div class="line">LOGFILE GROUP 1 (&apos;/s01/oradata/xwy/redo01.log&apos;) SIZE 10M BLOCKSIZE 512,</div><div class="line">GROUP 2 (&apos;/s01/oradata/xwy/redo02.log&apos;)  SIZE 10M BLOCKSIZE 512,</div><div class="line">GROUP 3 (&apos;/s01/oradata/xwy/redo03.log&apos;) SIZE 10M BLOCKSIZE 512</div><div class="line">MAXLOGFILES 5</div><div class="line">MAXLOGMEMBERS 5</div><div class="line">MAXLOGHISTORY 1</div><div class="line">MAXDATAFILES 100</div><div class="line">MAXINSTANCES 1</div><div class="line">CHARACTER SET AL32UTF8</div><div class="line">NATIONAL CHARACTER SET AL16UTF16</div><div class="line">EXTENT MANAGEMENT LOCAL</div><div class="line">DATAFILE &apos;/s01/oradata/xwy/system01.dbf&apos; SIZE 50M REUSE AUTOEXTEND ON</div><div class="line">SYSAUX DATAFILE &apos;/s01/oradata/xwy/sysaux01.dbf&apos; SIZE 50M REUSE AUTOEXTEND ON</div><div class="line">DEFAULT TABLESPACE USERS DATAFILE &apos;/s01/oradata/xwy/users01.dbf&apos; SIZE 50M REUSE AUTOEXTEND ON</div><div class="line">DEFAULT TEMPORARY TABLESPACE TEMP TEMPFILE &apos;/s01/oradata/xwy/temp01.dbf&apos; SIZE 20M REUSE AUTOEXTEND ON</div><div class="line">UNDO TABLESPACE UNDOTBS1 DATAFILE &apos;/s01/oradata/xwy/undotbs01.dbf&apos; SIZE 20M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED;</div></pre></td></tr></table></figure></li><li><p><strong>建立密码文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd $ORACLE_HOME/dbs</div><div class="line">$ orapwd file=orapwxwy password=xwy</div></pre></td></tr></table></figure></li><li><p><strong>启动数据库到nomount模式并执行创建数据脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ export ORACLE_SID=xwy</div><div class="line">$ sqlplus / as sysdba</div><div class="line">startup nomount</div><div class="line">@create_db</div></pre></td></tr></table></figure></li><li><p><strong>sys执行</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">spool cat.log</div><div class="line">@?/rdbms/admin/catalog.sql</div><div class="line">@?/rdbms/admin/catproc.sql</div><div class="line">@?/rdbms/admin/utlrp.sql</div></pre></td></tr></table></figure></li><li><p><strong>system执行</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spool pupbld.log</div><div class="line">@?/sqlplus/admin/pupbld.sql</div><div class="line">spool off</div></pre></td></tr></table></figure></li></ul><h4 id="创建em"><a href="#创建em" class="headerlink" title="创建em"></a>创建em</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ su - oracle</div><div class="line">$ emca -config dbcontrol db -repos create</div></pre></td></tr></table></figure><h3 id="安装中出现的问题"><a href="#安装中出现的问题" class="headerlink" title="安装中出现的问题"></a>安装中出现的问题</h3><h4 id="运行-runInstaller出现中文汉字为方框"><a href="#运行-runInstaller出现中文汉字为方框" class="headerlink" title="运行./runInstaller出现中文汉字为方框"></a>运行./runInstaller出现中文汉字为方框</h4><p>在/usr/lib/jvm/java-1.6.0/jre/lib/目录下建以下目录fonts/fallback，copy一种中文字体到些目录，并命名为zysong.ttf，安装提加参数<br>./runInstaller –jreLoc /usr/lib/jvm/java-1.6.0/jre即可解决中文方框问题。</p><h4 id="运行netca时中文字体出现方框"><a href="#运行netca时中文字体出现方框" class="headerlink" title="运行netca时中文字体出现方框"></a>运行netca时中文字体出现方框</h4><p>拷贝zysong.ttf到$ORACLE_HOME/ jdk/jre/lib/fonts/fallback目录下解决乱码。</p><h4 id="利用dbca创建数据库时提示ORA-12532"><a href="#利用dbca创建数据库时提示ORA-12532" class="headerlink" title="利用dbca创建数据库时提示ORA-12532"></a>利用dbca创建数据库时提示ORA-12532</h4><p>ORA-12532: TNS:invalid argument错误代码，是iptables没有开放1521端口，在iptables中添加以下条目-A INPUT -p tcp –dport 1521 -j ACCEPT解决问题。</p><h4 id="运行sqlplus时中文为？错误"><a href="#运行sqlplus时中文为？错误" class="headerlink" title="运行sqlplus时中文为？错误"></a>运行sqlplus时中文为？错误</h4><p>设置相应的环境变量NLS_LANG<br>export NLS_LANG=”SIMPLIFIED CHINESE_CHINA.ZHS16GBK”<br>并将写入oracle目录下的.bash_profile文件中。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://goo.gl/Bf0BPQ" title="基于VirtualBox在Linux 6.5上安装Oracle 11.2.0.4" rel="external nofollow noopener noreferrer" target="_blank">基于VirtualBox在Linux 6.5上安装Oracle 11.2.0.4 第二讲 安装Oracle数据库并创建数据库 | Oracle数据库安装课程 | Oracle | dbDao</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;&lt;em&gt;网上关于Linxu下安装Oralce的资料数不尽数，但是总找不到适合自己，用起来拿心应手的；以前数据库安装无数次，也没有总结、特参照
      
    
    </summary>
    
      <category term="Database" scheme="http://mapele.coding.me/categories/Database/"/>
    
      <category term="Oracle" scheme="http://mapele.coding.me/categories/Database/Oracle/"/>
    
      <category term="Install" scheme="http://mapele.coding.me/categories/Database/Oracle/Install/"/>
    
    
      <category term="oracle" scheme="http://mapele.coding.me/tags/oracle/"/>
    
      <category term="install" scheme="http://mapele.coding.me/tags/install/"/>
    
  </entry>
  
</feed>
